<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>星月小手机</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="stylesheet" href="style.css">
  <!-- 你的图标和manifest配置保持不变 -->
</head>
<body>
  <!-- ===== 锁屏层（默认显示） ===== -->
  <div id="lock-screen" style="
    z-index:9999;position:fixed;top:0;left:0;width:100vw;height:100vh;
    background: url('https://i.imgur.com/1n3a43H.jpeg') center/cover no-repeat;
    display:flex;flex-direction:column;justify-content:space-between;align-items:center;
    padding:80px 20px 50px 20px;box-sizing:border-box;
  ">
    <div id="lock-clock-container" style="text-align:center;">
      <div id="lock-main-time" style="font-size:80px;font-weight:200;color:white;text-shadow:0 3px 8px rgba(0,0,0,0.4);">00:00</div>
      <div id="lock-main-date" style="font-size:18px;font-weight:500;color:white;text-shadow:0 3px 8px rgba(0,0,0,0.4);">1月1日 星期一</div>
    </div>
    <div id="unlock-hint" style="font-size:16px;color:white;font-weight:500;text-shadow:0 1px 4px rgba(0,0,0,0.3);margin-top:60px;">
      上划 / 点击屏幕解锁
    </div>
<body>
  <div id="phone-screen">
    <div id="status-bar"> <span id="status-bar-time">12:00</span>
      <div id="status-bar-battery" class="battery-container"> <span class="battery-text">--%</span>
        <div class="battery-icon">
          <div class="battery-level"></div>
        </div>
      </div>
    </div>
    <div id="notification-bar"><img id="notification-avatar" src="">
      <div id="notification-content">
        <div class="name"></div>
        <div class="message"></div>
      </div>
    </div>
    <div id="home-screen" class="screen active">
      <div id="home-screen-pages-container">
        <div id="home-screen-pages">
          <div class="home-screen-page">
            <div id="main-content-area">
              <div id="profile-widget"> <img id="profile-banner-img" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                <div class="profile-avatar-container"> <img id="profile-avatar-img" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image"> </div>
                <div class="profile-info">
                  <p id="profile-username" class="editable-text">@ insonneve 🪦</p>
                  <p id="profile-sub-username" class="editable-text">@ insonneve</p>
                  <p id="profile-bio" class="editable-text">你好像过得很好 迫不及待的抹去我存在的痕迹</p>
                  <p id="profile-location" class="editable-text"> <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5-2.5-1.12 2.5-2.5 2.5z"></path>
                    </svg> <span>星月舱</span> </p>
                </div>
              </div>
              <div id="desktop-layout">
                <div id="desktop-widget-column">
                  <div class="desktop-widget text-only">
                    <p id="widget-text-1" class="editable-text">Be fearless in pursuit of happiness</p>
                  </div>
                  <div class="desktop-widget icon-left"> <img id="widget-avatar-1" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image"> <span id="widget-text-2" class="editable-text">Dare to be different</span> </div>
                  <div class="desktop-widget icon-right"> <span id="widget-text-3" class="editable-text">* Keep your spirit free</span> <img id="widget-avatar-2" src="https://i.imgur.com/5A0tE9a.jpeg" class="editable-image"> </div>
                </div>
                <div id="desktop-app-container">
                  <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div> <span class="label">QQ</span>
                  </div>
                  <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="世界书"></div> <span class="label">世界书</span>
                  </div>
                  <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="外观设置"></div> <span class="label">外观设置</span>
                  </div>
                  <div class="desktop-app-icon" onclick="openRenderingRulesScreen()">
                    <div class="icon-bg-desktop"><img id="icon-img-renderer" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="渲染器"></div> <span class="label">渲染器</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="home-screen-page">
            <div class="polaroid-widget-container">
              <div class="polaroid-photos">
                <div class="polaroid-photo" style="transform: rotate(-6deg);" onclick="handleWidgetImageChange('polaroid-img-1')"> <img id="polaroid-img-1" src="https://i.imgur.com/Bv63o3h.jpg" alt="Photo 1"> </div>
                <div class="polaroid-photo" style="transform: rotate(2deg);" onclick="handleWidgetImageChange('polaroid-img-2')"> <img id="polaroid-img-2" src="https://i.imgur.com/GzPzBfF.jpg" alt="Photo 2"> </div>
                <div class="polaroid-photo" style="transform: rotate(5deg);" onclick="handleWidgetImageChange('polaroid-img-3')"> <img id="polaroid-img-3" src="https://i.imgur.com/Wp72cEM.jpg" alt="Photo 3"> </div>
              </div>
            </div>
            <div id="page-2-app-container">
              <div class="large-widget" onclick="handleWidgetImageChange('large-widget-img')"> <img class="large-widget-img" id="large-widget-img" src="https://i.imgur.com/Bv63o3h.jpg" alt="Colorful Widget"> </div>
              <div class="app-subgrid">
                <div class="small-widget" onclick="openPresetScreen()">
                  <div class="small-widget-icon-wrapper"> <img class="small-widget-img" id="icon-img-preset" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg" alt="预设"> </div> <span class="small-widget-label">预设</span>
                </div>
                <div class="small-widget" onclick="showScreen('tutorial-screen')">
                  <div class="small-widget-icon-wrapper"> <img class="small-widget-img" id="icon-img-tutorial" src="https://i.postimg.cc/d10GjC4g/IMG-7302.jpg" alt="教程"> </div> <span class="small-widget-label">教程</span>
                </div>
                <div class="small-widget" onclick="openWerewolfLobby('global')">
                  <div class="small-widget-icon-wrapper"> <img class="small-widget-img" id="icon-img-werewolf" src="https://i.postimg.cc/k401K5g7/IMG-7304.jpg" alt="狼人杀"> </div> <span class="small-widget-label">狼人杀</span>
                </div>
                <div class="small-widget" onclick="showScreen('x-social-screen')">
                  <div class="small-widget-icon-wrapper"> <img class="small-widget-img" id="icon-img-x" src="https://i.postimg.cc/Y9d3BztC/1.png" alt="X"> </div> <span class="small-widget-label">X</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="home-screen-pagination">
        <div class="pagination-dot active"></div>
        <div class="pagination-dot"></div>
      </div>
      <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="API设置"></div> <span class="label">API设置</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="字体"></div> <span class="label">字体</span>
        </div>
        <div class="desktop-app-icon" onclick="openCharacterSelector()">
          <div class="icon-bg-desktop"><img id="icon-img-char-phone" src="https://i.postimg.cc/pXj9h20L/IMG-7275.jpg" alt="Cphone"></div> <span class="label">Cphone</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('douban-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-douban" src="https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg" alt="豆瓣"></div> <span class="label">豆瓣</span>
        </div>
      </div>
    </div>
    <div id="character-selection-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>选择一部手机</span> <span style="width: 30px;"></span> </div>
      <div id="character-grid" class="list-container"> </div>
    </div>
    <div id="character-phone-screen" class="screen">
      <div id="char-home-screen" class="char-screen active">
        <div id="char-clock-container">
          <div id="char-main-time">12:00</div>
          <div id="char-main-date">1月1日 星期一</div>
        </div>
        <div id="char-app-grid">
          <div class="app-row">
            <div class="app-icon" onclick="openCharApp('qq')">
              <div class="icon-bg"><img id="cphone-icon-img-qq" src=""></div><span class="label">QQ</span>
            </div>
            <div class="app-icon" onclick="openCharApp('album')">
              <div class="icon-bg"><img id="cphone-icon-img-album" src=""></div><span class="label">相册</span>
            </div>
            <div class="app-icon" onclick="openCharApp('browser')">
              <div class="icon-bg"><img id="cphone-icon-img-browser" src=""></div><span class="label">浏览器</span>
            </div>
            <div class="app-icon" onclick="openCharApp('taobao')">
              <div class="icon-bg"><img id="cphone-icon-img-taobao" src=""></div><span class="label">淘宝</span>
            </div>
          </div>
          <div class="app-row">
            <div class="app-icon" onclick="openCharApp('memo')">
              <div class="icon-bg"><img id="cphone-icon-img-memo" src=""></div><span class="label">备忘录</span>
            </div>
            <div class="app-icon" onclick="openCharApp('diary')">
              <div class="icon-bg"><img id="cphone-icon-img-diary" src=""></div><span class="label">日记</span>
            </div>
            <div class="app-icon" onclick="openCharApp('amap')">
              <div class="icon-bg"><img id="cphone-icon-img-amap" src=""></div><span class="label">高德地图</span>
            </div>
            <div class="app-icon" onclick="openCharApp('usage')">
              <div class="icon-bg"><img id="cphone-icon-img-usage" src=""></div><span class="label">App记录</span>
            </div>
          </div>
          <div class="app-row">
            <div class="app-icon" onclick="openCharApp('music')">
              <div class="icon-bg"><img id="cphone-icon-img-music" src=""></div><span class="label">网易云</span>
            </div>
            <div class="app-icon" onclick="switchToMyPhone()">
              <div class="icon-bg"><img id="cphone-icon-img-ephone" src=""></div><span class="label">Ephone</span>
            </div>
          </div>
        </div>
      </div>
      <div id="char-amap-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>足迹</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-amap-btn" title="重新生成足迹"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-amap-list" class="list-container"> </div>
      </div>
      <div id="char-qq-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>QQ</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-qq-btn" title="重新生成"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-chat-list" class="list-container"></div>
      </div>
      <div id="char-qq-conversation-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="back-to-char-qq-list-btn">‹</span> <span id="char-conversation-partner-name"></span> <span style="width: 30px;"></span> </div>
        <div id="char-conversation-messages" class="list-container"> </div>
        <div id="char-conversation-input-area" style="padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; background-color: #f7f7f7;"> <input type="text" id="char-simulated-input" placeholder="这是模拟对话，无法发送消息" disabled
            style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: #eee;"> <button id="char-simulated-send-btn" style="padding: 0 20px; border: none; background-color: var(--accent-color); color: white; border-radius: 6px; font-weight: 500;">发送</button> </div>
      </div>
      <div id="char-album-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>TA的相册</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-album-btn" title="重新生成相册内容"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div class="list-container">
          <div id="char-album-grid"></div>
        </div>
      </div>
      <div id="char-browser-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>TA的浏览器历史</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-browser-btn" title="重新生成浏览记录"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-browser-history" class="list-container"> </div>
      </div>
      <div id="char-browser-article-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharScreen('char-browser-screen')">‹</span> <span id="char-article-title" style="max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">文章</span>
          <div class="header-actions"> <span class="action-btn" id="favorite-article-btn" title="收藏"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> </div>
        </div>
        <div id="char-article-content" class="list-container" style="padding: 20px; font-size: 16px; line-height: 1.8; overflow-y: auto;"></div>
      </div>
      <div id="char-taobao-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>TA的淘宝订单</span>
          <div class="header-actions"> <span class="action-btn" id="char-wallet-btn" title="查看钱包" onclick="openCharWallet()"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M20 12V8H4v4"></path>
                <path d="M4 8V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2"></path>
                <path d="M18 12v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6"></path>
              </svg> </span> <span class="action-btn" id="regenerate-char-taobao-btn" title="重新生成购买记录"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-product-grid" class="list-container"></div>
      </div>
      <div id="char-wallet-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-wallet-back-btn">‹</span> <span>钱包</span> <span style="width: 30px;"></span> </div>
        <div id="char-wallet-content" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
      </div>
      <div id="char-memo-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>备忘录</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-memo-btn" title="重新生成备忘录"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> <span class="action-btn" id="add-char-memo-btn">+</span> </div>
        </div>
        <div id="char-memo-list" class="list-container" style="padding: 10px;"></div>
      </div>
      <div id="char-memo-detail-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-memo-detail-back-btn">‹</span> <span id="char-memo-detail-title"></span>
          <div class="header-actions"> <span class="action-btn" id="favorite-memo-btn" title="收藏"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> </div>
        </div>
        <div class="form-container" style="padding: 0;"> <textarea id="char-memo-detail-content" readonly></textarea> </div>
      </div>
      <div id="char-diary-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>日记</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-diary-btn" title="重新生成日记本"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> <span class="action-btn" id="add-char-diary-btn">+</span> </div>
        </div>
        <div id="char-diary-list" class="list-container"></div>
      </div>
      <div id="char-diary-detail-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-diary-detail-back-btn">‹ </span> <span id="char-diary-detail-title"></span>
          <div class="header-actions"> <span class="action-btn" id="favorite-diary-btn" title="收藏"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> </div>
        </div>
        <div id="char-diary-detail-content-wrapper" class="list-container">
          <div id="char-diary-detail-content"> </div>
        </div>
      </div>
      <div id="char-usage-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>App使用记录</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-usage-btn" title="重新生成记录"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-usage-list" class="list-container"> </div>
      </div>
      <div id="char-qq-transcript-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
          <div class="modal-header"> <span id="transcript-modal-char-name"></span> </div>
          <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
          <div class="modal-footer"> <button class="save" id="close-transcript-modal-btn" style="width:100%;">关闭</button> </div>
        </div>
      </div>
      <div id="char-music-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‹</span> <span>TA的歌单</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-music-btn" title="重新生成歌单"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-music-list" class="list-container"> </div>
      </div>
      <div id="char-music-player-modal" class="modal">
        <div class="modal-content">
          <div class="char-player-body">
            <div class="char-player-song-info">
              <p id="char-music-player-title">歌曲名称</p>
              <p id="char-music-artist">歌手</p>
            </div>
            <div id="char-vinyl-container"> <img id="char-music-cover" src=""> </div>
            <div id="char-music-lyrics"> </div>
            <div class="char-player-footer">
              <div class="char-player-progress-bar-container"> <span id="char-music-current-time" class="time-display">0:00</span>
                <div id="char-music-progress-bar" class="char-player-progress-bar">
                  <div id="char-music-progress-fill"></div>
                </div> <span id="char-music-total-time" class="time-display">0:00</span>
              </div>
              <div class="char-player-controls"> <button id="char-music-prev-btn" class="control-btn"> <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path>
                  </svg> </button> <button id="char-music-play-pause-btn" class="control-btn play"> <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                    <path d="M8 5v14l11-7z"></path>
                  </svg> </button> <button id="char-music-next-btn" class="control-btn"> <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"></path>
                  </svg> </button> <button id="char-music-mode-btn" class="control-btn mode">顺序</button> </div>
            </div>
          </div> <button id="close-char-music-player-btn" class="char-player-close-btn">×</button>
        </div>
      </div>
    </div>
    <div id="world-book-screen" class="screen">
      <div class="header">
        <div class="header-left-actions"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span class="action-btn" id="import-world-book-btn" title="导入世界书"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg> </span> <span class="action-btn" id="export-world-book-btn" title="导出世界书"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg> </span> </div> <span>世界书</span>
        <div class="header-actions"> <span class="action-btn" id="manage-world-book-categories-btn" title="管理分类"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg> </span> <span class="action-btn" id="add-world-book-btn">+</span> </div>
      </div>
      <div id="world-book-tabs"></div>
      <div id="world-book-content-container"></div>
    </div>
    <div id="world-book-editor-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('world-book-screen')">‹</span> <span id="world-book-editor-title">编辑世界书</span> <span class="save-btn" id="save-world-book-btn">保存</span> </div>
      <div class="form-container">
        <div class="form-group"> <label for="world-book-name-input">书名</label> <input type="text" id="world-book-name-input" placeholder="请输入世界书的名称..."> </div>
        <div class="form-group"> <label for="world-book-category-select">分类</label> <select id="world-book-category-select"></select> </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label>内容条目</label>
          <div id="world-book-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;"> </div>
        </div> <button id="add-world-book-entry-btn" class="form-button form-button-secondary"> [+] 添加新条目 </button>
      </div>
    </div>
    <div id="preset-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>预设</span>
        <div class="header-actions"> <span class="action-btn" id="import-preset-btn" title="导入预设文件"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg> </span> <span class="action-btn" id="manage-preset-categories-btn" title="管理分类"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg> </span> <span class="action-btn" id="add-preset-btn">+</span> </div>
      </div>
      <div id="preset-tabs"></div>
      <div id="preset-content-container"></div>
    </div>
    <div id="tutorial-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>教程</span> <span style="width: 30px;"></span> </div>
      <div class="list-container" style="padding: 0; overflow: hidden;"> <iframe id="tutorial-iframe" src="tutorial.html" style="width: 100%; height: 100%; border: none;"></iframe> </div>
    </div>
    <div id="preset-editor-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('preset-screen')">‹</span> <span id="preset-editor-title">编辑预设</span> <span class="save-btn" id="save-preset-btn">保存</span> </div>
      <div class="form-container">
        <div class="form-group"> <label for="preset-name-input">预设名称</label> <input type="text" id="preset-name-input" placeholder="请输入预设的名称..."> </div>
        <div class="form-group"> <label for="preset-category-select">分类</label> <select id="preset-category-select"></select> </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label>内容条目</label>
          <div id="preset-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;"> </div>
        </div> <button type="button" id="add-preset-entry-btn" class="form-button form-button-secondary"> [+] 添加新条目 </button>
      </div>
    </div>
    <div id="api-settings-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>API 设置</span> <span style="width: 30px;"></span> </div>
      <div class="form-container">
        <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API 预设管理</h3>
        <div class="form-group"> <label for="api-preset-select">选择或切换预设</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="api-preset-select" style="flex-grow: 1;"></select> <button id="save-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button> <button id="delete-api-preset-btn"
              class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button> </div>
        </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">主API设置 (用于聊天)</h3>
        <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> 提示: 若要使用“发送图片”功能, 请务必选择支持Vision(视觉)的模型, 如<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>或<code
            style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>。 </p>
        <div class="form-group"> <label for="proxy-url">反代地址 (不需要添加/v1噢~)</label> <input type="text" id="proxy-url" placeholder="例如: https://api.openai.com"> </div>
        <div class="form-group"> <label for="api-key">密钥 (API Key)</label> <input type="password" id="api-key" placeholder="sk-..."> </div>
        <div class="form-group"> <label for="model-select">模型</label> <select id="model-select"></select> </div> <button class="form-button" id="fetch-models-btn">拉取主模型</button>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">副API设置 (用于总结长期记忆)</h3>
        <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> 您可以在此配置一个独立的、可能成本更低的API，专门用于后台的长期记忆总结任务，以节省主API的费用。如果留空，将默认使用主API进行总结。 </p>
        <div class="form-group"> <label for="secondary-proxy-url">副反代地址</label> <input type="text" id="secondary-proxy-url" placeholder="例如: https://api.groq.com/openai"> </div>
        <div class="form-group"> <label for="secondary-api-key">副密钥</label> <input type="password" id="secondary-api-key" placeholder="gsk_..."> </div>
        <div class="form-group"> <label for="secondary-model-select">副模型</label> <select id="secondary-model-select"></select> </div> <button class="form-button form-button-secondary" id="fetch-secondary-models-btn">拉取副模型</button>
        <div class="form-group"> <label for="api-temperature-slider">API 温度 (Temperature) <span id="api-temperature-value">0.8</span></label>
          <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 控制AI回复的随机性和创造性。值越高，回复越随机；值越低，回复越确定。建议范围 0.7-1.0。 </p> <input type="range" id="api-temperature-slider" min="0" max="2" step="0.1" value="0.8" style="width: 100%; margin-top: 8px;">
        </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">后台活动设置</h3>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="background-activity-switch" style="margin-bottom: 0;"> 启用后台角色活动 <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;"> 警告：此功能会显著增加API调用和费用！ </p>
          </label> <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;"> </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"> <label for="background-interval-input" style="margin-bottom: 0;"> 后台活动检测间隔 (秒) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 建议值
              60-300。值越大，费用越低，但角色反应越慢。 </p> </label> <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;"> </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"> <label for="block-cooldown-input" style="margin-bottom: 0;"> AI被拉黑后冷静期 (小时) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
              被拉黑超过这个时间后，AI才有几率重新申请好友。 </p> </label> <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;"> </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">语音消息设置 (Minimax TTS)</h3>
        <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> 在 AI 回复的文字前加上 <code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">[V]</code> 前缀，即可让该条消息自动渲染为可播放的语音。</p>
        <div class="form-group"> <label for="minimax-group-id">Minimax Group ID</label> <input type="text" id="minimax-group-id" placeholder="在此输入你的 Group ID"></div>
        <div class="form-group"> <label for="minimax-api-key">Minimax API Key</label> <input type="password" id="minimax-api-key" placeholder="在此输入你的 API Key"></div>
        <div class="form-group"> <label for="minimax-model-select">语音模型 (Model)</label> <select id="minimax-model-select">
            <option value="speech-01">speech-01 (标准)</option>
            <option value="speech-02">speech-02 (高清)</option>
          </select></div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">性能与显示设置</h3>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"> <label for="chat-list-render-window-input" style="margin-bottom: 0;"> 聊天列表每次加载条数 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
              控制主页聊天列表下拉时每次加载会话的数量。默认30。 </p> </label> <input type="number" id="chat-list-render-window-input" min="10" value="30" style="width: 80px; text-align: center;"> </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;"> <label for="chat-render-window-input" style="margin-bottom: 0;"> 聊天界面初始加载条数 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
              打开聊天时默认显示的最近消息数量。值越大，初次加载越慢。 </p> </label> <input type="number" id="chat-render-window-input" min="10" value="50" style="width: 80px; text-align: center;"> </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">生图功能设置</h3>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="enable-ai-drawing-switch" style="margin-bottom: 0;"> 启用AI生图功能 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
              关闭后，所有需要AI生成的图片（动态、头像等）都将显示为占位图，以节省流量和API费用。 </p> </label> <label class="toggle-switch"> <input type="checkbox" id="enable-ai-drawing-switch"> <span class="slider"></span> </label> </div>
<!-- ▼▼▼ NovelAI 图像生成系统配置 ▼▼▼ -->
<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="novelai-switch" style="margin-bottom: 0;">
        启用 NovelAI 图像生成
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            开启后可使用NovelAI官方API生成高质量动漫风格图像（必开🔮）
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            1. 三击下载图片，下面可测试模型或关键词画师串
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            2. 429是novel的访问频繁错误，等待几秒重新即可
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            3. 403是多人共号限制，限制oplus免费出小图但可扣点数
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            4. 403也会因为没开🔮报错，实在不行可更换出图尺寸
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            5. 401是key没权限，检查key是否正确
        </p>
        <p style="font-size: 12px; font-weight: normal; color: #666; margin-top: 5px;">
            6. 生成失败:Failed to fetch是跨域限制，下方设置里换代理
      </p>
    </label>
    <label class="toggle-switch">
        <input type="checkbox" id="novelai-switch">
        <span class="slider"></span>
    </label>
</div>

<div id="novelai-details" style="display: none;">
    <div class="form-group">
        <label for="novelai-model" style="color: #333;">NovelAI 模型</label>
        <select id="novelai-model" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; border-radius: 4px;">
            <option value="nai-diffusion-4-curated-preview">NAI Diffusion V4.5 Curated (精选版无nsfw)</option>
            <option value="nai-diffusion-4-5-full">NAI Diffusion V4.5 Full（完整版含nsfw）</option>
            <option value="nai-diffusion-3">NAI Diffusion Anime V3（旧版）</option>
            <option value="nai-diffusion-furry-3">NAI Diffusion Furry V3（旧旧版）</option>
        </select>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            💡 必须有oplus订阅的apikey才可以使用！
        </p>
    </div>

    <div class="form-group">
        <label for="novelai-api-key" style="color: #333;">NovelAI API Key</label>
        <div style="position: relative;">
            <input type="password" id="novelai-api-key" placeholder="pst-xxxxxxxxxxxxxxxx" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding-right: 40px;">
            <span id="novelai-key-toggle" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; user-select: none; font-size: 18px;">🧐</span>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            💡 在 <a href="https://novelai.net" target="_blank" style="color: #007bff;">NovelAI官网</a> 获取API Key
        </p>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button type="button" id="novelai-settings-btn" style="flex: 1; background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            ⚙️ 生成设置
        </button>
        <button type="button" id="novelai-test-btn" style="flex: 1; background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            🧪 测试生成
        </button>
    </div>
</div>
<!-- ▲▲▲ NovelAI 图像生成系统配置结束 ▲▲▲ -->

<hr style="margin: 30px 0; opacity: 0.3;">
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">存储空间优化</h3>

        <p id="total-image-size-display" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; text-align: center;">
            正在计算本地图片总大小...
        </p>
        <button class="form-button form-button-secondary" id="compress-images-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">
             一键压缩本地图片
        </button>
        <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;">
            此功能会将您所有本地上传的图片（如头像、表情包、聊天图片、头像框、组件图等）压缩为JPEG格式，以大幅减小数据体积。
            <br><strong style="color: #ff3b30;">警告：这是一个有损压缩且不可逆的操作，会轻微降低图片质量。建议操作前先备份数据。</strong>
        </p>
        <hr style="margin: 30px 0; opacity: 0.3;"> <button class="form-button" id="save-api-settings-btn" style="margin-top: 20px;">保存所有设置</button> <button class="form-button" id="export-data-btn">导出数据</button> <button class="form-button" id="import-btn">导入备份文件</button><button
          class="form-button form-button-secondary" id="cleanup-data-btn" style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">清理冗余数据</button><button class="form-button form-button-secondary" id="delete-world-books-btn"
          style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">删除世界书</button><button class="form-button form-button-secondary" id="clear-specific-data-btn"
          style="background-color: #ffcdd2; color: #b71c1c; border-color: #ef9a9a; margin-top: 10px;">高级数据清理</button><button class="form-button form-button-secondary" id="check-and-fix-data-btn"
          style="background-color: #e3f2fd; color: #0d47a1; border-color: #bbdefb; margin-top: 10px;">数据检查与修复</button> <input id="import-data-input" type="file" accept="application/json" hidden>

      </div>
    </div>
    <div id="data-clear-wizard-modal" class="modal">
      <div class="modal-content" style="height: 80%;">
        <div id="data-clear-step-1" class="wizard-step">
          <div class="modal-header"> <span>第一步：选择要清理的角色</span> <label> <input type="checkbox" id="select-all-chars-for-clear"> 全选 </label> </div>
          <div class="modal-body" id="data-clear-char-list" style="padding: 0;"> </div>
          <div class="modal-footer"> <button class="cancel" id="cancel-clear-wizard-btn-step1">取消</button> <button class="save" id="go-to-clear-step2-btn">下一步</button> </div>
        </div>
        <div id="data-clear-step-2" class="wizard-step" style="display: none;">
          <div class="modal-header"> <span>第二步：选择要清理的数据类型</span> <label> <input type="checkbox" id="select-all-types-for-clear"> 全选 </label> </div>
          <div class="modal-body" id="data-clear-type-list" style="padding: 0;"> </div>
          <div class="modal-footer"> <button class="form-button-secondary" id="back-to-clear-step1-btn" style="width: 30%; margin:0;">上一步</button> <button class="cancel" id="cancel-clear-wizard-btn-step2" style="width: 30%; margin:0;">取消</button> <button class="save btn-danger"
              id="confirm-final-clear-btn" style="width: 30%; margin:0;">确认清理</button> </div>
        </div>
      </div>
    </div>
    <div id="chat-list-screen" class="screen">
      <div class="header" id="main-chat-list-header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span id="chat-list-title">消息</span>
        <div class="header-actions"> <span class="action-btn" id="add-group-chat-btn" title="创建群聊"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span> <span class="action-btn" id="add-chat-btn">+</span> </div>
      </div>
      <div id="messages-view" class="chat-list-view active">
        <div id="chat-list"> </div>
      </div>
      <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header"> <span class="back-btn" id="qzone-back-btn">‹</span> <span>好友动态</span>
          <div class="header-actions"> <span class="action-btn" id="qzone-more-actions-btn" title="更多操作">…</span> </div>
        </div>
        <div class="qzone-content">
          <div class="qzone-profile-header">
            <div id="qzone-banner-container" class="qzone-banner-container"> <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="背景"> <input type="file" id="qzone-banner-input" accept="image/*" hidden> </div>
            <div class="qzone-user-info">
              <div id="qzone-avatar-container" class="qzone-avatar-container"> <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="头像"> <input type="file" id="qzone-avatar-input" accept="image/*" hidden> </div> <span id="qzone-nickname">{{user}}</span>
            </div>
          </div>
          <div class="qzone-actions-bar">
            <div class="action-item" id="create-shuoshuo-btn"><span>说说</span></div>
            <div class="action-item" id="create-post-btn"><span>动态</span></div>
            <div class="action-item" id="open-album-btn"><span>相册</span></div>
          </div>
          <div id="qzone-posts-list"></div>
        </div>
      </div>
      <div id="favorites-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="favorites-back-btn">‹</span> <span>我的收藏</span> <span class="action-btn" id="favorites-edit-btn">编辑</span> </div>
        <div class="search-bar-container"> <input type="search" id="favorites-search-input" placeholder="搜索收藏的标题、内容或作者..."> <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">×</button> </div>
        <div id="favorites-list" class="list-container"> </div>
        <div id="favorites-action-bar" style="display: none;"> <button id="favorites-delete-selected-btn" class="action-bar-btn">删除 (0)</button> </div>
      </div>
      <div id="memories-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="memories-back-btn">‹</span> <span>我们的回忆</span> <span class="action-btn" id="add-countdown-btn">+</span> </div>
        <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
      </div>
      <div id="npc-list-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="npc-list-back-btn">‹</span> <span>NPC 列表</span>
          <div class="header-actions"> <span class="action-btn" id="add-npc-btn">+</span> </div>
        </div>
        <div id="npc-list" class="list-container" style="padding: 0;"> </div>
      </div>
      <div id="chat-list-bottom-nav">
        <div class="nav-item active" data-view="messages-view"> <span>消息</span> </div>
        <div class="nav-item" data-view="qzone-screen"> <span>动态</span> </div>
        <div class="nav-item" data-view="memories-view"> <span>回忆</span> </div>
        <div class="nav-item" data-view="favorites-view"> <span>收藏</span> </div>
        <div class="nav-item" data-view="npc-list-view"> <span>NPC</span> </div>
      </div>
    </div>
    <div id="album-screen" class="screen">
      <div class="header"> <span class="back-btn" id="album-back-btn">‹</span> <span>我的相册</span> <span class="action-btn" id="create-album-btn-page">+</span> </div>
      <div class="list-container">
        <div id="album-grid-page"> </div>
      </div>
    </div>
    <div id="album-photos-screen" class="screen">
      <div class="header"> <span class="back-btn" id="album-photos-back-btn">‹</span> <span id="album-photos-title">相册名称</span> <span class="action-btn" id="album-upload-photo-btn">上传</span> </div>
      <div class="list-container">
        <div id="photos-grid-page"> </div>
        <div id="photo-viewer-modal" class="modal"> <button id="photo-viewer-close-btn">×</button> <button id="photo-viewer-prev-btn" class="nav-arrow">‹</button>
          <div class="photo-viewer-content"> <img id="photo-viewer-image" src="" alt="全屏照片预览"> </div> <button id="photo-viewer-next-btn" class="nav-arrow">›</button>
        </div>
      </div>
    </div>
    <div id="npc-editor-modal" class="modal">
      <div class="modal-content" style="height: 80%;">
        <div class="modal-header"> <span id="npc-editor-title">添加 NPC</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>NPC 头像</label>
            <div class="avatar-upload"> <img id="npc-avatar-preview" src="https://i.postimg.cc/VkQfgzGJ/1.jpg"> <button onclick="document.getElementById('npc-avatar-input').click()">上传头像</button> <input type="file" id="npc-avatar-input" accept="image/*" hidden> </div>
          </div>
          <div class="form-group"> <label for="npc-name-input">NPC 昵称</label> <input type="text" id="npc-name-input" placeholder="输入NPC的常用名"> </div>
          <div class="form-group"> <label for="npc-persona-input">NPC 人设</label> <textarea id="npc-persona-input" rows="4" placeholder="详细描述这个NPC的性格、背景、说话方式等..."></textarea> </div>
          <hr style="opacity: 0.2;">
          <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="npc-background-activity-switch" style="margin-bottom: 0;"> 启用独立后台活动 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                允许该NPC在后台独立发表动态评论。需同时开启API设置中的总开关。 </p> </label> <label class="toggle-switch"> <input type="checkbox" id="npc-background-activity-switch"> <span class="slider"></span> </label> </div>
          <div class="form-group"> <label for="npc-action-cooldown-input"> 独立行动冷却 (分钟) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 该NPC在后台主动行动的最小间隔。 </p> </label> <input type="number" id="npc-action-cooldown-input" min="1" value="15"
              style="width: 80px; text-align: center;"> </div>
          <div class="form-group"> <label>关联的角色 (NPC会去评论这些角色的动态)</label>
            <div id="npc-association-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"> </div>
          </div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-npc-editor-btn">取消</button> <button class="save" id="save-npc-btn">保存</button> </div>
      </div>
    </div>
    <div id="clear-posts-modal" class="modal">
      <div class="modal-content" style="height: 70%;">
        <div class="modal-header"> <span>选择清空范围</span> </div>
        <div class="modal-body" id="clear-posts-list" style="padding: 0;"> </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-clear-posts-btn">取消</button> <button class="save btn-danger" id="confirm-clear-posts-btn">确认清空</button> </div>
      </div>
    </div> <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
    <div id="chat-interface-screen" class="screen">
      <div id="gomoku-overlay">
        <div id="gomoku-content-wrapper"> <canvas id="gomoku-board"></canvas>
          <div id="gomoku-controls"> <button id="close-gomoku-btn">收起棋盘</button> </div>
        </div>
      </div>
      <div id="reading-overlay">
        <div id="reading-restore-btn" style="display: none;">📖</div>
        <div id="reading-window">
          <div class="reading-header"> <span id="reading-title">未选择书籍</span>
            <div class="reading-controls"> <button id="minimize-reading-btn" title="最小化" style="font-size: 20px; line-height: 1;"> <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg> </button> <button id="open-reading-library-btn" title="打开书库" style="font-size: 22px; line-height: 1;"> <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg></button> <button id="close-reading-btn" title="关闭"> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg> </button></div>
          </div>
          <div id="reading-content">
            <p>点击“导入”按钮，<br>从本地.txt文件或网络URL加载书籍内容。</p>
          </div>
          <div class="reading-footer"> <button id="prev-page-btn">上一页</button> <span id="page-indicator">0 / 0</span> <button id="next-page-btn">下一页</button> </div>
        </div>
      </div><input type="file" id="book-upload-input" accept=".txt, text/plain" hidden>
      <div class="header">
        <div class="default-controls"> <span class="back-btn" id="back-to-list-btn">‹</span>
          <div id="global-lyrics-bar"></div>
          <div id="chat-header-title-wrapper"> <span id="chat-header-title">聊天对象</span>
            <div id="chat-header-status"> <span class="status-dot"></span> <span class="status-text">在线</span> </div>
          </div>
          <div class="header-actions"> <span class="action-btn" id="open-memory-screen-btn" title="长期记忆"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 6L9 9L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M21 5V19C21 20.1046 20.1046 21 19 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg> </span> <span class="action-btn" id="listen-together-btn" title="一起听"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="一起听"></span> <span class="action-btn" id="chat-settings-btn" title="聊天设置"><img
                src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="设置"></span> </div>
        </div>
        <div class="selection-controls"> <span id="selection-cancel-btn">取消</span> <span id="selection-count"></span>
          <div class="header-actions"> <span id="selection-screenshot-btn" class="action-btn">长截图</span> <span id="selection-favorite-btn" class="action-btn">收藏</span> <span id="selection-share-btn" class="action-btn">分享</span> <span id="selection-soft-delete-btn" class="action-btn">删除(通知AI)</span>
            <span id="selection-erase-btn" class="action-btn" style="color: #ff3b30;">彻底删除</span> </div>
        </div>
      </div>
      <div id="chat-messages">
        <div id="typing-indicator">对方正在输入...</div>
      </div>
      <div id="chat-input-area">
        <div id="chat-at-mention-popup" class="at-mention-popup"></div>
        <div id="reply-preview-bar">
          <div class="reply-preview-content">
            <div class="sender">回复 xxx:</div>
            <div class="text">被引用的消息内容...</div>
          </div> <span id="cancel-reply-btn">×</span>
        </div>
        <div id="chat-input-actions-top"> <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="表情面板">+</button> <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="发送照片"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg></button> <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="上传图片"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg> </button> <button id="transfer-btn" class="chat-action-icon-btn action-button" title="转账">￥</button> <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="发送语音"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <path d="M12 19v4"></path>
              <path d="M8 23h8"></path>
            </svg></button> <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="发起外卖请求"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg></button> <button id="video-call-btn" class="chat-action-icon-btn action-button" title="视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg></button> <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="群视频通话"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg></button> <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="发起投票"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 6h10"></path>
              <path d="M6 6h.01"></path>
              <path d="M8 12h10"></path>
              <path d="M6 12h.01"></path>
              <path d="M8 18h10"></path>
              <path d="M6 18h.01"></path>
            </svg></button> <button id="share-link-btn" class="chat-action-icon-btn action-button" title="分享链接"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
            </svg></button> <button id="share-location-btn" class="chat-action-icon-btn action-button" title="共享位置"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg></button> <button id="gomoku-btn" class="chat-action-icon-btn action-button" title="五子棋"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="4"></circle>
              <circle cx="12" cy="12" r="7"></circle>
            </svg> </button> <button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="购物"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg> </button> <button id="pat-btn" class="chat-action-icon-btn action-button" title="拍一-拍" style="display: none;"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 5.02c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M14.5 11.02c0 .83-.67 1.5-1.5 1.5v0c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5v0c.83 0 1.5.67 1.5 1.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M5.5 14.52l-1.92-1.92c-.34-.34-.34-.89 0-1.23l3.58-3.58c.34-.34.89-.34 1.23 0l1.92 1.92c.34.34.34.89 0 1.23l-3.58 3.58c-.34.34-.89.34-1.23 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg> </button> <button id="edit-last-response-btn" class="chat-action-icon-btn action-button" title="导演模式：编辑AI上一轮的完整响应"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg> </button> <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="重新生成回复" style="display: flex;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </button> <button id="propel-btn" class="chat-action-icon-btn action-button" title="推进剧情" style="display: flex;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <polygon points="13 19 22 12 13 5 13 19"></polygon>
              <polygon points="2 19 11 12 2 5 2 19"></polygon>
            </svg> </button> <button id="show-announcement-board-btn" class="chat-action-icon-btn action-button" title="群公告板" style="display: none;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.782 6.132a1 1 0 0 0-1.053-.08l-4.729 2.489a1 1 0 0 0-.5.88v4.158a1 1 0 0 0 .5.88l4.729 2.489a1 1 0 0 0 1.053-.08a1 1 0 0 0 .499-.921V7.052a1 1 0 0 0-.499-.92zm-6 3.207L11 7.05v9.9l4.782-2.281V9.339zM10 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6V6z" />
            </svg> </button><button id="werewolf-game-btn" class="chat-action-icon-btn action-button" title="狼人杀" style="display: none;"> <svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M332.6 128.5c-61.1 0-110.5 49.4-110.5 110.5 0 23.4 7.3 45.1 19.9 63.3-19.3 6.3-40.1 9.7-61.9 9.7-88.2 0-160-71.8-160-160s71.8-160 160-160c5.3 0 10.5.3 15.6.8C202.9 44.1 160 0 160 0s-53.3 44.1-45.9 92.5c-48.4 24.3-82.1 73.4-82.1 129.6 0 80.9 65.5 146.4 146.4 146.4 20.2 0 39.4-4.1 56.8-11.5 24.1 33.6 63.3 56.8 107.4 56.8 7.2 0 14.2-0.6 21-1.7 15.2 24.2 41.2 41.1 71.6 41.1 44.7 0 80.9-36.2 80.9-80.9 0-25.2-11.5-47.7-29.6-62.6 11.6-16.1 18.4-35.6 18.4-56.5C443.1 177.9 393.7 128.5 332.6 128.5zM180.1 85.8c-52.1 0-94.4 42.3-94.4 94.4s42.3 94.4 94.4 94.4 94.4-42.3 94.4-94.4S232.2 85.8 180.1 85.8zM332.6 170.9c-37.8 0-68.4 30.6-68.4 68.4s30.6 68.4 68.4 68.4 68.4-30.6 68.4-68.4S370.4 170.9 332.6 170.9z">
              </path>
            </svg></button><button id="read-together-btn" class="chat-action-icon-btn action-button" title="一起读书"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg></button> </div>
        <div id="chat-input-main-row"> <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
          <div id="input-actions-wrapper"> <button id="wait-reply-btn" title="等待回复"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="等待回复"></button> <button id="send-btn" class="action-button">发送</button> </div>
        </div>
      </div>
      <div id="chat-lock-overlay">
        <div id="chat-lock-content"></div>
      </div>
      <div id="sticker-panel">
        <div id="sticker-panel-header"> <span class="panel-btn" id="close-sticker-panel-btn">取消</span> <span class="title">我的表情</span>
          <div style="display: flex; gap: 10px;"> <span class="panel-btn" id="manage-sticker-categories-btn">分类</span> <span class="panel-btn" id="manage-stickers-btn">管理</span> <span class="panel-btn" id="add-sticker-batch-btn">批量</span> <span class="panel-btn" id="upload-sticker-btn">上传</span> </div>
        </div>
        <div id="sticker-category-tabs"></div>
        <div id="sticker-search-container"> <input type="search" id="sticker-search-input" placeholder="搜索表情名称..."></div>
        <div id="sticker-grid"></div>
        <div id="sticker-action-bar"> <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-stickers-checkbox"> 全选 </label> <button id="delete-selected-stickers-btn">删除 (0)</button> </div>
      </div> <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;"> <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
      <div id="music-player-overlay">
        <div class="music-player-window">
          <div class="music-player-top-actions">
            <div class="top-left-cluster"> <button id="music-return-btn">‹</button> <button id="music-exit-btn">×</button> </div>
            <div style="display: flex; align-items: center; gap: 15px;"> <button id="toggle-fullscreen-btn" title="切换全屏"> <svg class="icon-maximize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                </svg> <svg class="icon-minimize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" />
                </svg> </button> <span id="music-playlist-btn">☰</span> </div>
          </div>
          <div id="music-player-avatar-display"> </div>
          <div id="music-info-top">
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
              <div id="music-time-counter">已经一起听了0.0小时</div> <button id="show-avatars-btn" title="显示/隐藏头像"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg> </button>
            </div>
            <div id="music-player-song-title">请添加歌曲</div>
            <div id="music-player-artist">...</div>
          </div>
          <div id="music-visual-container">
            <div id="vinyl-view"> <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art"> </div>
            <div id="inline-lyrics-view">
              <div id="music-lyrics-container">
                <div id="music-lyrics-list"> </div>
              </div>
            </div>
          </div>
          <div id="single-lyric-display">♪ ♪ ♪</div>
          <div class="music-player-controls-wrapper">
            <div class="music-progress-bar-container">
              <div id="music-current-time" class="time-display">0:00</div>
              <div class="progress-bar">
                <div id="music-progress-fill" class="progress-bar-fill"></div>
              </div>
              <div id="music-total-time" class="time-display">0:00</div>
            </div>
            <div class="music-controls"> <button id="music-prev-btn">◀</button> <button id="music-play-pause-btn" class="play-pause-btn">▶</button> <button id="music-next-btn">▶</button> <button id="music-mode-btn">顺序</button> <button id="toggle-blur-btn" title="切换背景清晰度">清</button>
            </div>
          </div>
        </div>
      </div>
      <div id="music-playlist-panel">
        <div class="playlist-header"> <span class="panel-btn" id="close-playlist-btn">返回</span> <span>播放列表</span>
          <div> <span class="panel-btn" id="cleanup-songs-btn">清理</span> <span class="panel-btn" id="add-song-local-btn">本地</span> <span class="panel-btn" id="add-song-url-btn">URL</span> <span class="panel-btn" id="add-song-search-btn">搜索</span> </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
      </div> <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;"> <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
    </div>
    <div id="wallpaper-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>外观设置</span> <span style="width: 30px;"></span> </div>
      <div class="form-container"> <label style="font-weight: 500; color: var(--text-secondary);">EPhone 主屏幕壁纸</label>
        <div id="wallpaper-preview">点击下方上传</div>
        <div class="bg-upload-container"> <button class="form-button-secondary" onclick="document.getElementById('wallpaper-upload-input').click();">本地上传</button> <button id="upload-ephone-bg-url-btn" class="form-button-secondary">网络URL</button> <button id="remove-ephone-bg-btn"
            class="form-button-secondary">移除壁纸</button> </div> <input type="file" id="wallpaper-upload-input" accept="image/*" hidden>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;"> <label style="font-weight: 500; color: var(--text-secondary);">CPhone 手机壁纸</label>
        <div id="cphone-wallpaper-preview">点击下方上传</div>
        <div class="bg-upload-container"> <button class="form-button-secondary" onclick="document.getElementById('cphone-wallpaper-upload-input').click();">本地上传</button> <button id="upload-cphone-bg-url-btn" class="form-button-secondary">网络URL</button> <button id="remove-cphone-bg-btn"
            class="form-button-secondary">移除壁纸</button> </div> <input type="file" id="cphone-wallpaper-upload-input" accept="image/*" hidden>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;"> <label style="font-weight: 500; color: var(--text-secondary);">全局聊天背景 (所有聊天默认)</label>
        <div id="global-bg-preview" class="wallpaper-preview" style="height: 160px; width: 90px;">点击下方上传</div>
        <div class="bg-upload-container"> <button class="form-button-secondary" onclick="document.getElementById('global-bg-input').click()">本地上传</button> <button id="upload-global-bg-url-btn" class="form-button-secondary">网络URL</button> <button id="remove-global-bg-btn"
            class="form-button-secondary">移除全局背景</button> </div> <input type="file" id="global-bg-input" accept="image/*" style="display: none;">
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="theme-toggle-switch" style="margin-bottom: 0;">夜间模式</label> <label class="toggle-switch"> <input type="checkbox" id="theme-toggle-switch"> <span class="slider"></span>
          </label> </div>
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="status-bar-toggle-switch" style="margin-bottom: 0;">显示顶部状态栏</label> <label class="toggle-switch"> <input type="checkbox" id="status-bar-toggle-switch"> <span
              class="slider"></span> </label> </div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;"> <label style="font-weight: 500; color: var(--text-secondary);">消息提示音</label> </div>
        <div class="form-group" style="width:100%;"> <label for="notification-sound-url-input">提示音文件 URL (.mp3, .wav, .ogg)</label>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;"> <input type="text" id="notification-sound-url-input" placeholder="留空则使用默认提示音" style="flex-grow: 1;"> <button id="test-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">▶</button>
            <button id="reset-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">重置</button> </div>
        </div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;"> <label style="font-weight: 500; color: var(--text-secondary);">EPhone App 图标设置</label> </div>
        <div id="icon-settings-grid"></div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div class="form-group" style="width:100%;">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;"> <label>聊天工具栏按钮排序</label> <button id="reset-button-order-btn" title="恢复默认顺序" class="form-button-secondary" style="margin: 0; padding: 4px 12px; font-size: 13px;">重置顺序</button> </div>
          <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 按住下方的按钮并拖动即可排序，设置会自动保存。 </p>
          <div id="button-order-editor" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background-color: #f0f2f5; border-radius: 8px; border: 1px solid var(--border-color);"> </div>
        </div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;"> <label style="font-weight: 500; color: var(--text-secondary);">CPhone App 图标设置</label> </div>
        <div id="cphone-icon-settings-grid"></div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; width:100%; text-align: left;">外观预设管理</h3>
        <p style="font-size: 12px; color: #8a8a8a; margin-top: -5px; line-height: 1.5; width:100%; text-align: left;"> 一键保存或加载壁纸、图标、按钮排序、主题等所有非CSS的视觉风格。</p>
        <div class="form-group" style="width:100%;"> <label for="appearance-preset-select">选择或切换预设</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="appearance-preset-select" style="flex-grow: 1;"></select> <button id="save-appearance-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button> <button
              id="delete-appearance-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button> </div>
        </div>
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <h3 style="margin-top:0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; width:100%; text-align: left;">CSS 预设管理</h3>
        <div class="form-group" style="width:100%;"> <label for="css-preset-select">选择或切换预设</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="css-preset-select" style="flex-grow: 1;"></select> <button id="save-css-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button> <button id="delete-css-preset-btn"
              class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button> </div>
        </div>
        <div class="form-group" style="width:100%;"> <label for="global-css-input"> 全局美化样式 (CSS) <button id="reset-global-css-btn" type="button"
              style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button> </label> <textarea id="global-css-input" rows="6"
            style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* 在此输入自定义CSS */"></textarea> </div> <button class="form-button form-button-secondary" id="import-appearance-btn" style="margin-top: 10px;">导入外观 (JSON)</button>
        <input type="file" id="import-appearance-input" accept="application/json" hidden> <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">保存所有外观设置</button>
      </div>
    </div>
    <div id="browser-screen" class="screen">
      <div class="header"> <span class="back-btn" id="browser-back-btn">‹</span> <span id="browser-title"></span> <span style="width: 30px;"></span> </div>
      <div id="browser-content" class="list-container"> </div>
    </div>
    <div id="font-settings-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>字体设置</span> <span style="width: 30px;"></span> </div>
      <div class="form-container">
        <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">字体预设管理</h3>
        <div class="form-group"> <label for="font-preset-select">选择或切换预设</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="font-preset-select" style="flex-grow: 1;"></select> <button id="save-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button> <button id="delete-font-preset-btn"
              class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button> </div>
        </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <div class="form-group"> <label for="font-url-input">字体文件URL (.ttf, .otf, .woff等)</label> <input type="text" id="font-url-input" placeholder="https://..../font.ttf"> </div>
        <div class="form-group"> <label>实时预览</label>
          <div id="font-preview">
            <p style="font-size: 20px; margin: 0 0 10px 0;">你好世界 Hello World</p>
            <p style="margin: 0;">这是字体预览效果，12345。</p>
          </div>
        </div> <button class="form-button" id="save-font-btn">保存并应用</button> <button class="form-button form-button-secondary" id="reset-font-btn">恢复默认字体</button>
      </div>
    </div>
    <div id="contact-picker-screen" class="screen">
      <div class="header"> <span class="back-btn" id="cancel-contact-picker-btn">取消</span> <span>选择联系人</span> <span class="save-btn" id="confirm-contact-picker-btn">完成(0)</span> </div>
      <div class="list-container" id="contact-picker-list"> </div>
    </div>
    <div id="member-management-screen" class="screen">
      <div class="header"> <span class="back-btn" id="back-from-member-management">‹</span> <span>群成员管理</span> <span style="width: 30px;"></span> </div>
      <div class="list-container" id="member-management-list"> </div>
      <div id="member-management-actions"> <button id="add-existing-contact-btn">从好友列表添加</button> <button id="create-new-member-btn">创建群内新成员</button> </div>
    </div>
    <div id="sticker-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%;">
        <div class="modal-header"> <span>管理表情分类</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>新建分类</label>
            <div style="display: flex; gap: 10px;"> <input type="text" id="new-sticker-category-name-input" placeholder="输入分类名..." style="flex-grow: 1;"> <button id="add-new-sticker-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button> </div>
          </div>
          <hr style="opacity: 0.2;">
          <div id="existing-sticker-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
        </div>
        <div class="modal-footer"> <button class="save" id="close-sticker-category-manager-btn" style="width: 100%;">完成</button> </div>
      </div>
    </div>
    <div id="incoming-call-modal" class="modal">
      <div class="incoming-call-content"> <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">邀请你视频通话</div>
        <div class="incoming-call-actions">
          <div class="action-button-wrapper"> <button id="decline-call-btn" class="call-action-btn decline"></button> <span>拒绝</span> </div>
          <div class="action-button-wrapper"> <button id="accept-call-btn" class="call-action-btn accept"></button> <span>接听</span> </div>
        </div>
      </div>
    </div>
    <div id="video-call-screen" class="screen">
      <div class="video-call-top-bar"> <span id="call-timer">00:00</span> </div>
      <div class="video-call-avatar-area">
        <div id="participant-avatars-grid"> </div>
      </div>
      <div id="video-call-main" class="video-call-main"> </div>
      <div class="video-call-controls"> <button id="user-speak-btn" class="control-btn speak-btn"></button> <button id="hang-up-btn" class="control-btn hangup-btn"></button> <button id="regenerate-call-btn" class="control-btn regenerate-btn"></button> <button id="join-call-btn"
          class="control-btn join-btn" style="display: none;"></button> </div>
    </div>
    <div id="outgoing-call-screen" class="screen">
      <div class="outgoing-call-content"> <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">正在呼叫...</div>
        <div class="outgoing-call-actions"> <button id="cancel-call-btn" class="call-action-btn decline"></button> <span>取消</span> </div>
      </div>
    </div>
    <div id="call-history-screen" class="screen">
      <div class="header"> <span class="back-btn" id="call-history-back-btn">‹</span> <span id="call-history-title">通话记录</span> <span style="width: 30px;"></span> </div>
      <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
    </div>
    <div id="douban-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>豆瓣小组</span>
        <div class="header-actions"> <span class="action-btn" id="douban-settings-btn" title="豆瓣设置"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z">
              </path>
            </svg> </span> <span class="action-btn" id="douban-cast-select-btn" title="选择参与角色"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg> </span> <span class="action-btn" id="regenerate-douban-btn" title="重新生成内容"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </span> </div>
      </div>
      <div id="douban-posts-list" class="list-container"> </div>
    </div>
    <div id="douban-post-detail-screen" class="screen">
      <div class="header"> <span class="back-btn" id="douban-detail-back-btn">‹</span> <span id="douban-post-detail-title">帖子详情</span> <span style="width: 30px;"></span> </div>
      <div id="douban-detail-content-wrapper" class="list-container">
        <div id="douban-post-detail-body">
          <div class="douban-post-header"> <img id="douban-detail-avatar" class="douban-post-avatar">
            <div class="douban-author-info">
              <div id="douban-detail-author" class="douban-author-name"></div>
              <div id="douban-detail-group" class="douban-group-name"></div>
            </div>
          </div>
          <h2 id="douban-detail-post-title" class="douban-post-title"></h2>
          <div id="douban-detail-content" class="douban-detail-content"></div>
        </div>
        <div class="douban-comments-section">
          <h4>回应</h4>
          <div id="douban-detail-comments-list"></div>
        </div>
      </div>
      <div id="douban-comment-footer" class="post-footer">
        <div class="comment-section"> <img id="douban-my-comment-avatar" src="" class="comment-avatar"> <input type="text" id="douban-comment-input" class="comment-input" placeholder="写回应..."> </div> <button id="douban-wait-reply-btn" class="douban-feather-btn" title="让AI继续讨论"> <svg
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
            <line x1="16" y1="8" x2="2" y2="22"></line>
            <line x1="17.5" y1="15" x2="9" y2="15"></line>
          </svg> </button> <button id="douban-send-comment-btn" class="comment-send-btn">发送</button>
      </div>
    </div>
    <div id="werewolf-game-screen" class="screen">
      <div class="header"> <span id="werewolf-game-title">狼人杀</span>
        <div class="header-actions"><span class="action-btn" id="werewolf-retry-btn" title="重试上一步AI操作" style="display: none;"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg></span> <span class="action-btn" id="exit-werewolf-game-btn">退出</span> </div>
      </div>
      <div id="werewolf-player-grid"></div>
      <div id="werewolf-log" class="list-container"></div>
      <div id="werewolf-action-bar">
        <div id="chat-input-main-row" style="width: 100%;"> <textarea id="werewolf-user-input" rows="1" placeholder="轮到你发言了..."></textarea>
          <div id="input-actions-wrapper" style="gap: 5px;"> <button id="werewolf-wait-reply-btn" class="action-button" style="display: none; background-color: #007bff; height: 40px; padding: 0 10px; font-size: 13px;">等待回应</button> <button id="werewolf-finish-speech-btn" class="action-button"
              style="display: none; background-color: var(--accent-color); height: 40px; padding: 0 10px; font-size: 13px;">结束发言</button> <button id="werewolf-next-step-btn" class="form-button" style="margin-top:0; display: none;">下一步</button> </div>
        </div>
      </div>
    </div>
    <div id="long-term-memory-screen" class="screen">
      <div class="header"> <span class="back-btn" id="memory-screen-back-btn">‹</span> <span>长期记忆</span>
        <div class="header-actions"> <span class="action-btn" id="refine-memory-btn-header">精炼</span> <span class="action-btn" id="summarize-recent-btn-header">总结</span> <span class="action-btn" id="add-manual-memory-btn-header">+</span> </div>
      </div>
      <div class="list-container" id="memory-list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5;"> </div>
    </div>
    <div id="chat-settings-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('chat-interface-screen')">‹</span> <span>聊天设置</span> <span class="save-btn" id="save-chat-settings-btn">保存</span> </div>
      <div class="form-container">
        <div class="form-group" id="chat-name-group"><label for="chat-name-input">备注名 / 群名</label><input type="text" id="chat-name-input"></div>
        <div class="form-group" id="my-nickname-group"> <label for="my-nickname-input">我的昵称</label> <input type="text" id="my-nickname-input"> </div>
        <div class="form-group" id="assign-group-section" style="display: none;"> <label for="assign-group-select">好友分组</label>
          <div style="display: flex; align-items: center; gap: 10px;"> <select id="assign-group-select" style="flex-grow: 1;"></select> <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">管理分组</button> </div>
        </div>
        <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">我的群昵称</label><input type="text" id="my-group-nickname-input"></div> <button class="form-button form-button-secondary" id="search-history-btn" style="margin-top: 10px;">搜索聊天记录</button>
        <div class="form-group" id="single-char-background-activity-group">
          <div class="form-group" id="inject-thought-group">
            <div style="display: flex; justify-content: space-between; align-items: center;"> <label for="inject-thought-toggle" style="margin-bottom: 0;"> 注入最新心声 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 开启后，AI在回应前会“看到”自己上一轮的内心独白。这能增强连贯性，但可能轻微增加Token消耗。 </p>
              </label> <label class="toggle-switch"> <input type="checkbox" id="inject-thought-toggle"> <span class="slider"></span> </label> </div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;"> <label for="char-background-activity-switch" style="margin-bottom: 0;"> 启用独立后台活动 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 允许该角色在后台独立发消息或动态。需同时开启API设置中的总开关。 </p> </label>
            <label class="toggle-switch"> <input type="checkbox" id="char-background-activity-switch"> <span class="slider"></span> </label> </div>
        </div>
        <div class="form-group" id="ai-cooldown-group"> <label for="ai-action-cooldown-input"> 独立行动冷却 (分钟) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AI在后台主动发消息或动态的最小间隔。 </p> </label> <input type="number" id="ai-action-cooldown-input" min="1" value="10"
            style="width: 80px; text-align: center;"> </div>
        <div class="form-group" id="time-perception-group">
          <div style="display: flex; justify-content: space-between; align-items: center;"> <label for="time-perception-toggle" style="margin-bottom: 0;"> 启用时间感知 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 关闭后，AI将不会接收到当前时间信息，对话中不再体现时间变化。 </p> </label>
            <label class="toggle-switch"> <input type="checkbox" id="time-perception-toggle"> <span class="slider"></span> </label>
          </div>
        </div>
        <div class="form-group" id="time-zone-group" style="display: none;"> <label for="time-zone-select">选择时区</label> <input type="search" id="time-zone-search-input" placeholder="搜索时区，例如 Shanghai, New York..."> <select id="time-zone-select" style="width: 100%;"></select></div>
        <div class="form-group" id="group-background-activity-group">
          <div style="display: flex; justify-content: space-between; align-items: center;"> <label for="group-background-activity-switch" style="margin-bottom: 0;"> 启用群内后台活动 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 允许AI成员在该群聊中独立行动。需同时开启API设置中的总开关。 </p> </label>
            <label class="toggle-switch"> <input type="checkbox" id="group-background-activity-switch"> <span class="slider"></span> </label> </div>
        </div>
        <div class="form-group" id="group-cooldown-group"> <label for="group-action-cooldown-input"> 群聊行动冷却 (分钟) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AI在后台主动在群内行动的最小间隔。 </p> </label> <input type="number" id="group-action-cooldown-input" min="1" value="10"
            style="width: 80px; text-align: center;"> </div>
        <div class="form-group" id="group-avatar-group"> <label>群头像</label>
          <div class="avatar-upload"> <img id="group-avatar-preview"> <button onclick="document.getElementById('group-avatar-input').click()">上传群头像</button> <button id="manage-group-avatar-library-btn">管理头像库</button> <input type="file" id="group-avatar-input" accept="image/*"> </div>
        </div>
        <div class="form-group" id="world-book-link-group"> <label>关联世界书 (可多选)</label>
          <div class="custom-multiselect">
            <div class="select-box"> <span class="selected-options-text">-- 点击选择 --</span> <span class="arrow-down">▼</span> </div>
            <div id="world-book-checkboxes-container" class="checkboxes-container"> </div>
          </div>
        </div>
        <div class="form-group" id="lyrics-position-group" style="display: none;">
          <hr style="opacity: 0.3; margin: 20px 0;"> <label>歌词栏位置</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
            <div> <label for="lyrics-vertical-pos" style="font-size: 0.9em; color: var(--text-secondary);">垂直位置</label> <select id="lyrics-vertical-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                <option value="top">顶部</option>
                <option value="bottom">底部</option>
              </select> </div>
            <div> <label for="lyrics-horizontal-pos" style="font-size: 0.9em; color: var(--text-secondary);">水平对齐</label> <select id="lyrics-horizontal-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                <option value="left">居左</option>
                <option value="center">居中</option>
                <option value="right">居右</option>
              </select> </div>
          </div>
          <div style="margin-top: 10px;"> <label for="lyrics-offset-input" style="font-size: 0.9em; color: var(--text-secondary);">垂直偏移 (px)</label> <input type="number" id="lyrics-offset-input" value="10"
              style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box;"> </div>
        </div>
        <div class="form-group" id="offline-mode-group">
          <hr style="opacity: 0.3; margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"> <label for="offline-mode-toggle" style="margin-bottom: 0;"> 启用线下模式 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 开启后, AI的回复将变为包含「对话」和<i
                  style="color: #666;">动作/环境描写</i>的剧情模式。 </p> </label> <label class="toggle-switch"> <input type="checkbox" id="offline-mode-toggle"> <span class="slider"></span> </label> </div>
          <div id="offline-mode-options" style="display: none; margin-top: 15px;"> <label for="offline-min-length-input">回复字数范围</label>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;"> <input type="number" id="offline-min-length-input" value="100" style="width: 80px; text-align: center;"> <span>到</span> <input type="number" id="offline-max-length-input" value="300"
                style="width: 80px; text-align: center;"> <span>字</span> </div>
            <div class="form-group" style="margin-top: 15px; margin-bottom: 0;"> <label for="offline-preset-select">文风预设 (将影响AI的描写风格)</label> <select id="offline-preset-select" style="width: 100%; margin-top: 5px;"></select> </div>
          </div>
        </div>
        <div class="form-group" id="linked-memory-group"> <label for="link-memory-toggle">挂载其他聊天记忆</label> <input type="checkbox" id="link-memory-toggle" style="width: auto; height: 20px; vertical-align: middle; margin-left: 10px;">
          <div id="linked-memory-selection" style="display: none; margin-top: 10px;"> <label>选择要挂载记忆的聊天 (可多选):</label>
            <div class="custom-multiselect">
              <div class="select-box"> <span class="selected-options-text">-- 点击选择 --</span> <span class="arrow-down">▼</span> </div>
              <div id="linked-chats-checkboxes-container" class="checkboxes-container" style="max-height: 120px;"> </div>
            </div>
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> • 挂载的记忆会以“参考记忆”的形式提供给AI，不会直接显示在聊天界面。<br> • 建议每个聊天挂载3-10轮记忆，避免影响响应速度。 </p>
          </div>
        </div>
        <div class="form-group" id="ai-original-name-group"> <label for="ai-original-name-input">对方本名 (AI识别用)</label> <input type="text" id="ai-original-name-input"> </div>
        <div class="form-group" id="ai-persona-group"><label for="ai-persona">对方人设 (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
        <div class="form-group" id="ai-avatar-group"><label>对方头像</label>
          <div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">上传对方头像</button><button id="manage-ai-avatar-library-btn">管理头像库</button><button class="change-frame-btn" data-type="ai">更换头像框</button> <input type="file"
              id="ai-avatar-input" accept="image/*"> </div>
        </div>
        <div class="form-group" id="my-persona-group"><label for="my-persona">我的人设 (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div>
        <div class="form-group" id="switch-greeting-group" style="display: none;"> <label>切换开场 (会清空当前对话)</label> <button id="switch-greeting-btn" class="form-button form-button-secondary" style="margin-top: 5px;">选择其他开场故事...</button> </div>
        <div class="form-group" id="my-avatar-group"> <label>我的头像</label>
          <div class="avatar-upload"> <img id="my-avatar-preview"> <button onclick="document.getElementById('my-avatar-input').click()">上传我的头像</button> <button id="manage-my-avatar-library-btn">管理头像库</button> <button class="change-frame-btn" data-type="my">更换头像框</button> <button
              id="open-persona-library-btn">预设</button> <input type="file" id="my-avatar-input" accept="image/*"> </div>
        </div>
        <div class="form-group" id="group-members-group"><label>群成员人设</label>
          <div id="group-members-settings"></div> <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">管理群成员</button>
        </div>
        
        <div class="form-group" id="group-nai-settings-group" style="display: none;">
        <hr style="opacity: 0.2; margin: 20px 0;">
        <label style="font-weight: 600; color: var(--accent-color);">NAI出图设置</label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            为当前角色配置专属的NovelAI出图提示词
        </p>
        
        <div style="margin-top: 15px;">
            <label style="font-weight: 500; color: #333;">提示词来源</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="system" checked style="width: auto; margin-right: 8px;">
                    <span>使用系统设置</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="character" style="width: auto; margin-right: 8px;">
                    <span>使用当前角色配置</span>
                </label>
            </div>
        </div>
        
        <button id="group-character-nai-prompts-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 15px;">配置角色专属提示词</button>
    </div>
        
        <div class="form-group" id="tts-enable-group">
          <div style="display: flex; justify-content: space-between; align-items: center;"> <label for="enable-tts-switch" style="margin-bottom: 0;"> 启用语音合成 (TTS) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 关闭后，即使AI回复包含 [V] 前缀，也不会生成语音消息。 </p> </label>
            <label class="toggle-switch"> <input type="checkbox" id="enable-tts-switch"> <span class="slider"></span> </label>
          </div>
        </div>
        <div class="form-group" id="ai-voice-id-group"> <label for="ai-voice-id-input">语音 ID (Minimax voice_id)</label> <input type="text" id="ai-voice-id-input" placeholder="例如: female-shaonv-jingpin"></div>
        
        <!-- NAI出图设置（单聊显示） -->
    <div class="form-group" id="nai-character-settings-group" style="display: none;">
        <hr style="opacity: 0.2; margin: 20px 0;">
        <label style="font-weight: 600; color: var(--accent-color);">NAI出图设置</label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            为当前角色配置专属的NovelAI出图提示词
        </p>
        
        <div style="margin-top: 15px;">
            <label style="font-weight: 500; color: #333;">提示词来源</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="nai-prompt-source" value="system" checked style="width: auto; margin-right: 8px;">
                    <span>使用系统设置</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="nai-prompt-source" value="character" style="width: auto; margin-right: 8px;">
                    <span>使用当前角色配置</span>
                </label>
            </div>
        </div>
        
        <button id="character-nai-prompts-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 15px;">配置角色专属提示词</button>
    </div>

    <!-- NAI出图设置（群聊显示） -->
    <div class="form-group" id="group-nai-settings-group" style="display: none;">
        <hr style="opacity: 0.2; margin: 20px 0;">
        <label style="font-weight: 600; color: var(--accent-color);">NAI出图设置</label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            为当前角色配置专属的NovelAI出图提示词
        </p>
        
        <div style="margin-top: 15px;">
            <label style="font-weight: 500; color: #333;">提示词来源</label>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="system" checked style="width: auto; margin-right: 8px;">
                    <span>使用系统设置</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="group-nai-prompt-source" value="character" style="width: auto; margin-right: 8px;">
                    <span>使用当前角色配置</span>
                </label>
            </div>
        </div>
        
        <button id="group-character-nai-prompts-btn" class="form-button form-button-secondary" style="width: 100%; margin-top: 15px;">配置角色专属提示词</button>
    </div>

        <div class="form-group"> <label for="max-memory">短期记忆（上下文）条数</label> <input type="number" id="max-memory" value="10"> </div>
        <div class="form-group"> <label for="linked-memory-count">挂载记忆条数</label> <input type="number" id="linked-memory-count" value="10">
          <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> • 每次调用时，从每个“挂载的聊天”中提取最后几条记录作为参考记忆。 <br> • 建议值 5-20。值越大记忆越全，但API费用越高、响应越慢。 </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="auto-memory-toggle" style="margin-bottom: 0;"> 启用自动总结长期记忆 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 开启后，AI会在对话达到一定长度时，自动将内容提炼为长期记忆。 </p>
          </label> <label class="toggle-switch"> <input type="checkbox" id="auto-memory-toggle"> <span class="slider"></span> </label> </div>
        <div class="form-group"> <label for="auto-memory-interval">自动总结间隔（消息条数）</label> <input type="number" id="auto-memory-interval" min="10" value="20" style="width: 80px; text-align: center;">
          <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px;"> 建议值 15-30。值越小，总结越频繁，但API费用也越高。 </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group"> <label>聊天气泡主题 <button id="reset-theme-btn" type="button">重置</button></label>
          <div class="theme-selector"> <label><input type="radio" name="theme-select" value="default" id="theme-default"> 默认</label> <label><input type="radio" name="theme-select" value="pink_blue"> 粉蓝</label> <label><input type="radio" name="theme-select" value="blue_white"> 蓝白</label>
            <label><input type="radio" name="theme-select" value="purple_yellow"> 紫黄</label> <label><input type="radio" name="theme-select" value="black_white"> 黑白</label> <label><input type="radio" name="theme-select" value="yellow_white"> 黄白</label> <label><input type="radio" name="theme-select"
                value="red_black"> 红黑</label> <label><input type="radio" name="theme-select" value="blue_yellow"> 蓝黄</label> <label><input type="radio" name="theme-select" value="pink_yellow"> 粉黄</label> <label><input type="radio" name="theme-select" value="pink_purple"> 粉紫</label> <label><input
                type="radio" name="theme-select" value="gray_white"> 灰白</label> <label><input type="radio" name="theme-select" value="blue_green"> 蓝绿</label> <label><input type="radio" name="theme-select" value="pink_white"> 粉白</label>
            <label><input type="radio" name="theme-select" value="pink_black"> 粉黑</label> <label><input type="radio" name="theme-select" value="pink_green"> 粉绿</label> <label><input type="radio" name="theme-select" value="green_black"> 绿黑</label>
          </div>
        </div>
        <div class="form-group"> <label for="font-size-slider">聊天字体大小 <span id="font-size-value">13px</span></label> <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;"> </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group"> <label for="theme-preset-select">主题预设管理</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="theme-preset-select" style="flex-grow: 1;"></select> <button id="save-theme-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button> <button id="delete-theme-preset-btn"
              class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button> </div>
        </div>
        <div class="form-group"> <label for="custom-css-input"> 自定义气泡样式 (CSS) <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">重置</button>
          </label> <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;"
            placeholder="/* 示例：为“我”的气泡添加渐变背景和阴影 */ .message-bubble.user .content { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 15px 4px 15px 15px; }"></textarea> </div>
        <div class="form-group"> <label>实时预览</label>
          <div id="settings-preview-area"></div>
        </div>
        <div class="form-group"> <label>聊天背景</label>
          <div class="bg-upload-container"> <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">上传背景图</button> <button type="button" id="remove-bg-btn">移除背景</button> </div> <img
            id="bg-preview" class="bg-preview-img"> <input type="file" id="bg-input" accept="image/*" style="display: none;">
        </div>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"> <button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">拉黑对方</button>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="export-single-chat-btn" style="background-color: #e8f5e9; color: #2e7d32; border-color: #c8e6c9;">导出该聊天</button><button class="form-button form-button-secondary"
          id="import-single-chat-btn" style="background-color: #fff3e0; color: #ef6c00; border-color: #ffe0b2;">导入该聊天</button><input type="file" id="import-single-chat-input" accept="application/json" hidden> <button class="form-button form-button-secondary" id="clear-chat-btn">清空聊天记录</button>
      </div>
    </div>
    <div id="rendering-rules-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‹</span> <span>渲染规则</span> <span class="action-btn" id="add-new-rule-btn">+</span> </div>
      <div id="rules-tabs"> </div>
      <div id="rules-content-container"> </div>
    </div>
    <div id="rule-editor-modal" class="modal">
      <div class="modal-content" style="height: 85%;">
        <div class="modal-header"> <span id="rule-editor-title">创建新规则</span> </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
          <div class="form-group" style="flex-shrink: 0;"> <label for="rule-name-input">规则名称</label> <input type="text" id="rule-name-input" placeholder="例如：美团外卖卡片"> </div>
          <div class="form-group" style="flex-shrink: 0;"> <label for="rule-chat-id-select">绑定范围</label> <select id="rule-chat-id-select">
              <option value="global">公用 (所有角色)</option>
            </select> </div>
          <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label for="rule-regex-input">正则表达式 (使用g作为标志)</label> <textarea id="rule-regex-input" rows="3" style="font-family: monospace; resize: vertical;" placeholder="例如：MTR\[(.*?)\]\[(.*?)\|(.*?)\]"></textarea>
          </div>
          <div class="form-group" style="flex-grow: 2; display: flex; flex-direction: column;"> <label for="rule-template-input">HTML 模板 (用 $1, $2 引用)</label> <textarea id="rule-template-input" rows="6" style="font-family: monospace; resize: vertical;"
              placeholder="例如：<div class=`waimai-card`>...<span>$2</span>...</div>"></textarea> </div>
          <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;"> <label for="rule-enabled-switch" style="margin-bottom: 0;">启用规则</label> <label class="toggle-switch"> <input type="checkbox" id="rule-enabled-switch" checked>
              <span class="slider"></span> </label> </div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-rule-editor-btn">取消</button> <button class="save" id="save-rule-btn">保存规则</button> </div>
      </div>
    </div>
    <div id="search-history-screen" class="screen">
      <div class="header"> <span class="back-btn" id="search-history-back-btn">‹</span> <span>搜索聊天记录</span> <span style="width: 30px;"></span> </div>
      <div id="search-bar" style="padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--secondary-bg); flex-shrink: 0;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;"> <input type="search" id="keyword-search-input" placeholder="输入关键词..." style="flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;"> <input type="date" id="date-search-input"
            style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;"> </div>
        <div style="display: flex; gap: 10px;"> <button id="execute-search-btn" class="form-button" style="margin-top: 0; flex-grow: 1;">搜索</button> <button id="clear-search-btn" class="form-button form-button-secondary" style="margin-top: 0; flex-grow: 1;">重置</button> </div>
      </div>
      <div id="chat-search-results-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
    </div>
    <div id="shopping-screen" class="screen">
      <div class="header">
        <div class="header-left-actions"> <span class="back-btn" id="shopping-back-btn">‹</span> <span class="action-btn" id="generate-shopping-items-btn" title="AI生成商品"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </span> <span class="action-btn" id="shopping-settings-btn" title="生成设置"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z">
              </path>
            </svg> </span> <span class="action-btn" id="delete-current-category-btn" title="删除当前分类" style="display: none; color: rgb(255, 59, 48);"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
              <line x1="18" y1="9" x2="12" y2="15"></line>
              <line x1="12" y1="9" x2="18" y2="15"></line>
            </svg> </span> </div> <span>购物中心</span>
        <div class="header-actions"> <span class="action-btn" id="manage-products-btn" title="管理商品" style="color: var(--text-primary);"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg> </span> <span class="action-btn" id="add-new-product-btn" title="添加新商品"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg> </span> <span class="action-btn" id="go-to-cart-btn" title="查看购物车"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg> <span id="cart-count">0</span> </span> </div>
      </div>
      <div id="product-category-tabs"></div>
      <div id="product-grid" class="list-container"> </div>
      <div id="shopping-action-bar"> <label class="select-all-label"> <input type="checkbox" id="select-all-products-checkbox"> 全选 </label> <button id="delete-selected-products-btn" class="action-bar-btn">删除 (0)</button> </div>
    </div>
    <div id="product-detail-screen" class="screen">
      <div class="header"> <span class="back-btn" id="product-detail-back-btn">‹</span> <span>商品详情</span> <span style="width: 30px;"></span> </div>
      <div id="product-detail-content" class="list-container"> </div>
      <div id="product-detail-footer"> <button class="footer-btn add-to-cart-detail-btn">加入购物车</button> <button class="footer-btn buy-now-btn">立即购买</button> </div>
    </div>
    <div id="cart-screen" class="screen">
      <div class="header"> <span class="back-btn" id="cart-back-btn">‹</span> <span id="cart-title">购物车(0)</span> <span class="action-btn" id="clear-cart-btn">清空</span> </div>
      <div id="cart-items-list" class="list-container"> </div>
      <div id="cart-footer"> <label class="select-all-label"><input type="checkbox" id="select-all-cart-items"> 全选</label>
        <div class="cart-summary">
          <div id="cart-total">合计: ¥0.00</div> <span class="cart-subtext">不含运费</span>
        </div> <button id="checkout-btn">结算(0)</button>
      </div>
    </div>
    <div id="product-editor-modal" class="modal">
      <div class="modal-content" style="height: 85%;">
        <div class="modal-header"> <span id="product-editor-title">添加商品</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>商品图片</label>
            <div class="avatar-upload"> <img id="product-image-preview" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg"> <button onclick="document.getElementById('product-image-input').click()">上传图片</button> <input type="file" id="product-image-input"
                accept="image/*" hidden> </div>
          </div>
          <div class="form-group"> <label for="product-name-input">商品名称</label> <input type="text" id="product-name-input"> </div>
          <div class="form-group"> <label for="product-category-select">商品分类</label>
            <div style="display: flex; align-items: center; gap: 10px;"> <select id="product-category-select" style="flex-grow: 1;"></select> <button id="manage-product-categories-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">管理</button> </div>
          </div>
          <div class="form-group"> <label for="product-price-input">默认价格 (元)</label> <input type="number" id="product-price-input" min="0" step="0.01"> </div>
          <div class="form-group"> <label for="product-description-input">商品描述</label> <textarea id="product-description-input" rows="3" placeholder="详细介绍一下这个商品..."></textarea> </div>
          <hr style="opacity: 0.2; margin: 20px 0;">
          <div class="form-group"> <label>商品款式</label>
            <p style="font-size: 12px; color: #888; margin-top: -5px; margin-bottom: 10px;">如果没有添加任何款式，将使用上面的默认价格。</p>
            <div id="product-variations-container" style="display: flex; flex-direction: column; gap: 15px;"> </div> <button id="add-product-variation-btn" class="form-button form-button-secondary" style="margin-top: 15px;">+ 添加新的一款</button>
          </div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-product-editor-btn">取消</button> <button class="save" id="save-product-btn">保存</button> </div>
      </div>
    </div>
    <div id="gift-receipt-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"> <span>购物小票</span> </div>
        <div class="modal-body" id="gift-receipt-body"> </div>
        <div class="modal-footer"> <button class="save" id="close-receipt-btn" style="width:100%;">关闭</button> </div>
      </div>
    </div>
  </div>
  </div> <input type="file" id="import-card-input" accept=".json,.png" style="display: none;"> <input type="file" id="import-world-book-input" accept=".json" style="display: none;">
  <div id="persona-library-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span>我的人设库</span><button id="add-persona-preset-btn" class="action-button">添加</button></div>
      <div class="modal-body">
        <div id="persona-library-grid"></div>
      </div>
      <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">关闭</button></div>
    </div>
  </div>
  <div id="persona-editor-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span id="persona-editor-title">添加人设预设</span></div>
      <div class="modal-body">
        <div class="form-group"><label>预设头像</label>
          <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">上传头像</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
        </div>
        <div class="form-group"><label for="preset-persona-input">预设人设</label><textarea id="preset-persona-input" rows="4" placeholder="在此输入这个人设的详细设定..."></textarea></div>
      </div>
      <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">取消</button><button class="save" id="save-persona-preset-btn">保存</button></div>
    </div>
  </div>
  <div id="member-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span>编辑群成员</span></div>
      <div class="modal-body">
        <div class="form-group"><label for="member-name-input">名字</label><input type="text" id="member-name-input"></div>
        <div class="form-group"><label for="member-persona-input">人设</label><textarea id="member-persona-input" rows="4"></textarea></div>
        <div class="form-group"><label>头像</label>
          <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">上传头像</button><button class="change-frame-btn" data-type="member">更换头像框</button><input type="file" id="member-avatar-input" accept="image/*"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">取消</button><button class="save" id="save-member-settings-btn">保存</button></div>
    </div>
  </div>
  <div id="custom-modal-overlay">
    <div id="custom-modal">
      <div class="custom-modal-header" id="custom-modal-title"></div>
      <div class="custom-modal-body" id="custom-modal-body"></div>
      <div class="custom-modal-footer"> <button id="custom-modal-cancel">取消</button> <button id="custom-modal-confirm" class="confirm-btn">确定</button> </div>
    </div>
  </div>
  <div id="preset-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="preset-action-edit">编辑预设</button> <button id="preset-action-delete" class="btn-danger">删除预设</button> <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button> </div>
    </div>
  </div>
  <div id="transfer-modal">
    <div class="transfer-content">
      <div class="transfer-header">给Ta一个惊喜！</div>
      <div class="transfer-input-group"> <label for="transfer-amount">转账金额</label> <input type="number" id="transfer-amount" placeholder="0.00" min="0" step="0.01"> </div>
      <div class="transfer-input-group"> <label for="transfer-note">备注 (可选)</label> <input type="text" id="transfer-note" placeholder="留下你的小心思~" maxlength="20"> </div>
      <div class="transfer-actions"> <button id="transfer-cancel-btn">取消</button> <button id="transfer-confirm-btn">确认转账</button> </div>
    </div>
  </div>
  <div id="battery-alert-modal">
    <div class="battery-alert-content"> <img id="battery-alert-image" src="">
      <p id="battery-alert-text"></p>
    </div>
  </div>
  <div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
      <div class="modal-header"> <span>发起外卖订单</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="waimai-product-info">商品信息</label> <input type="text" id="waimai-product-info" placeholder="例如：一杯杨枝甘露"> </div>
        <div class="form-group"> <label for="waimai-amount">订单金额 (元)</label> <input type="number" id="waimai-amount" placeholder="例如：21" min="0" step="0.01"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="waimai-order-for-ai-btn">为TA点单</button> <button class="save" id="waimai-confirm-btn">发起请求</button> </div>
    </div>
  </div>
  <div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
      <div class="modal-header"> <span>新建约定</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="countdown-title-input">约定标题</label> <input type="text" id="countdown-title-input" placeholder="例如：我的生日"> </div>
        <div class="form-group"> <label for="countdown-date-input">约定日期与时间</label> <input type="datetime-local" id="countdown-date-input"> </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-countdown-btn">取消</button> <button class="save" id="confirm-create-countdown-btn">保存约定</button> </div>
    </div>
  </div>
  <div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>发红包</span> </div>
      <div class="modal-body" style="padding: 0;">
        <div class="frame-tabs">
          <div id="rp-tab-group" class="frame-tab active">拼手气红包</div>
          <div id="rp-tab-direct" class="frame-tab">专属红包</div>
        </div>
        <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
          <div class="form-group"> <label>总金额 (元)</label> <input type="number" id="rp-group-amount" placeholder="0.00"> </div>
          <div class="form-group"> <label>红包个数</label> <input type="number" id="rp-group-count" placeholder="填写红包个数"> </div>
          <div class="form-group"> <label>祝福语</label> <input type="text" id="rp-group-greeting" placeholder="恭喜发财，大吉大利！"> </div>
          <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p> <button id="send-group-packet-btn" class="form-button">塞钱进红包</button>
        </div>
        <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
          <div class="form-group"> <label>发送给</label> <select id="rp-direct-receiver"></select> </div>
          <div class="form-group"> <label>金额 (元)</label> <input type="number" id="rp-direct-amount" placeholder="0.00"> </div>
          <div class="form-group"> <label>祝福语</label> <input type="text" id="rp-direct-greeting" placeholder="恭喜发财，大吉大利！"> </div>
          <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¥ 0.00</p> <button id="send-direct-packet-btn" class="form-button">塞钱进红包</button>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center;"> <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">取消</button> </div>
    </div>
  </div>
  <div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
      <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
        <div style="text-align: center; width: 100%;">
          <div id="rp-details-sender" style="font-size: 16px;"></div>
          <div style="font-size: 13px; opacity: 0.8;">的红包</div>
        </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
        <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;"> <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span> <span style="font-size: 18px; color: #E44D44;">元</span> </div>
        <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
        <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-rp-details-btn" style="width: 100%;">关闭</button> </div>
    </div>
  </div>
  <div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>发起投票</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="poll-question-input">投票问题</label> <textarea id="poll-question-input" rows="2" placeholder="例如：今晚我们看什么电影？"></textarea> </div>
        <div class="form-group"> <label>投票选项 (至少2项)</label>
          <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;"> </div> <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ 添加选项</button>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-poll-btn">取消</button> <button class="save" id="confirm-create-poll-btn">发起投票</button> </div>
    </div>
  </div>
  <div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="ai-avatar-library-title">对方的头像库</span>
        <div class="header-actions"> <button id="add-ai-avatar-batch-btn" class="action-button">批量</button> <button id="add-ai-avatar-url-btn" class="action-button">URL</button> <button id="add-ai-avatar-upload-btn" class="action-button">上传</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">关闭</button> </div>
    </div>
  </div>
  <div id="my-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="my-avatar-library-title">我的头像库</span>
        <div class="header-actions"> <button id="add-my-avatar-batch-btn" class="action-button">批量</button> <button id="add-my-avatar-url-btn" class="action-button">URL</button> <button id="add-my-avatar-upload-btn" class="action-button">上传</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-my-avatar-library-btn" style="width: 100%;">关闭</button> </div>
    </div>
  </div>
  <div id="group-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="group-avatar-library-title">群头像库</span>
        <div class="header-actions"> <button id="add-group-avatar-batch-btn" class="action-button">批量</button> <button id="add-group-avatar-url-btn" class="action-button">URL</button> <button id="add-group-avatar-upload-btn" class="action-button">上传</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="group-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-group-avatar-library-btn" style="width: 100%;">关闭</button> </div>
    </div>
  </div>
  <div id="chat-list-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="chat-list-action-pin"></button> <button id="chat-list-action-delete" class="btn-danger">删除聊天</button> <button id="chat-list-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button> </div>
    </div>
  </div>
  <div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>分享链接</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="link-title-input">标题</label> <input type="text" id="link-title-input" placeholder="输入文章或链接的标题"> </div>
        <div class="form-group"> <label for="link-description-input">摘要 (可选)</label> <textarea id="link-description-input" rows="2" placeholder="简单描述一下链接内容"></textarea> </div>
        <div class="form-group"> <label for="link-source-input">来源名称 (可选)</label> <input type="text" id="link-source-input" placeholder="例如：知乎日报、B站"> </div>
        <div class="form-group"> <label for="link-content-input">完整内容 (可选，用于浏览器内显示)</label> <textarea id="link-content-input" rows="4" placeholder="粘贴或输入完整的文章内容"></textarea> </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-share-link-btn">取消</button> <button class="save" id="confirm-share-link-btn">分享</button> </div>
    </div>
  </div>
  <div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
      <div class="transfer-actions-header">请选择操作</div>
      <div class="transfer-actions-body">
        <p>你收到了来自 <strong id="transfer-sender-name"></strong> 的一笔转账。</p>
      </div>
      <div class="transfer-actions-footer"> <button id="transfer-action-decline" class="action-btn decline">残忍拒绝</button> <button id="transfer-action-accept" class="action-btn accept">开心收下</button> </div> <button id="transfer-action-cancel" class="cancel-btn">×</button>
    </div>
  </div>
  <div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="transcript-modal-title">通话详情</span> </div>
      <div class="modal-body" id="call-transcript-modal-body" style="background-color: #f0f2f5;"> </div>
      <div class="modal-footer"> <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">删除记录</button> <button class="save" id="manual-summarize-btn" style="background-color: #ffc107; border-color: #ffc107;">手动总结</button>
        <button class="save" id="close-call-transcript-btn" style="width: 100%;">关闭</button>
      </div>
    </div>
  </div>
  <div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>分享到...</span> </div>
      <div class="modal-body" id="share-target-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-share-target-btn">取消</button> <button class="save" id="confirm-share-target-btn">确认分享</button> </div>
    </div>
  </div>
  <div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span id="shared-history-viewer-title">聊天记录</span> </div>
      <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;"> </div>
      <div class="modal-footer"> <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">关闭</button> </div>
    </div>
  </div>
  <div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>管理世界书分类</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>新建分类</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-category-name-input" placeholder="输入分类名..." style="flex-grow: 1;"> <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-category-manager-btn" style="width: 100%;">完成</button> </div>
    </div>
  </div>
  <div id="announcement-board-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>群公告板</span> </div>
      <div id="announcement-board-content"> </div>
      <div class="modal-footer"> <button class="save" id="close-announcement-board-btn" style="width: 100%;">关闭</button> </div>
    </div>
  </div>
  <div id="announcement-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="announcement-action-pin">置顶公告</button> <button id="announcement-action-delete" class="btn-danger">删除公告</button> <button id="announcement-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button> </div>
    </div>
  </div>
  <div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>管理好友分组</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>新建分组</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-group-name-input" placeholder="输入分组名..." style="flex-grow: 1;"> <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-group-manager-btn" style="width: 100%;">完成</button> </div>
    </div>
  </div>
  <div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-message-btn">编辑消息</button> <button id="copy-message-btn">复制文本</button> <button id="copy-timestamp-btn">复制时间戳</button> <button id="recall-message-btn">撤回</button> <button id="publish-to-announcement-btn" style="display: none;">发布到公告板</button>
        <button id="quote-message-btn">引用</button> <button id="select-message-btn">进入多选</button> <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button> </div>
    </div>
  </div>
  <div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-post-btn">编辑动态</button> <button id="copy-post-btn">复制内容</button> <button id="cancel-post-action-btn">取消</button> </div>
    </div>
  </div>
  <div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
      <div class="modal-header"> <span>编辑与拆分消息</span> </div>
      <div class="modal-body" id="message-editor-body">
        <div id="message-editor-container"></div> <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] 添加下一条消息 </button>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-advanced-editor-btn">取消</button> <button class="save" id="save-advanced-editor-btn">保存更改</button> </div>
    </div>
  </div>
  <div id="ai-response-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span>导演剪辑室 (AI上一轮响应)</span> </div>
      <div class="modal-body" id="ai-response-editor-body">
        <div id="ai-response-editor-container" style="display: flex; flex-direction: column; gap: 15px;"></div> <button id="add-ai-response-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] 添加一个新动作 </button>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-ai-response-editor-btn">取消</button> <button class="save" id="save-ai-response-editor-btn">应用修改</button> </div>
    </div>
  </div>
  <div id="repost-modal" class="modal">
    <div id="custom-modal" style="width: 280px;">
      <div class="custom-modal-header">转发动态</div>
      <div class="custom-modal-body"> <textarea id="repost-comment-input" placeholder="请输入转发评论 (可选)" style="width: 100%; min-height: 60px; resize: vertical; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 16px; box-sizing: border-box;"></textarea> </div>
      <div class="custom-modal-footer"> <button id="repost-cancel-btn">取消</button> <button id="repost-confirm-btn" class="confirm-btn">确定</button> </div>
    </div>
  </div>
  <div id="call-message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-call-message-btn">编辑</button> <button id="delete-call-message-btn" class="btn-danger">删除</button> <button id="cancel-call-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">取消</button> </div>
    </div>
  </div> <audio id="audio-player" style="display:none;"></audio>
  <div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
      <div class="modal-header"> <span>发布动态</span> </div>
      <div class="modal-body">
        <div class="form-group"> <textarea id="post-public-text" rows="3" placeholder="分享新鲜事...（非必填的公开文字）"></textarea> </div>
        <div class="post-mode-switcher"> <button id="switch-to-image-mode" class="mode-btn active">上传图片</button> <button id="switch-to-text-image-mode" class="mode-btn">使用文字图</button> </div>
        <div class="form-group"> <label>可见范围</label>
          <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;"> <label><input type="radio" name="visibility" value="public" checked> 公开</label> <label><input type="radio" name="visibility" value="include"> 指定分组可见</label> </div>
          <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"> </div>
        </div>
        <div id="image-mode-content" class="post-mode-content active">
          <div class="form-group">
            <div id="post-image-preview-container" class="post-image-preview-container"> <img id="post-image-preview" src="" alt="图片预览"> <button id="post-remove-image-btn">×</button> </div>
            <div class="post-image-upload-options"> <button id="post-upload-local-btn" class="form-button-secondary">本地上传</button> <button id="post-use-url-btn" class="form-button-secondary">网络URL</button> <input type="file" id="post-local-image-input" accept="image/*" hidden> </div>
          </div>
          <div id="post-image-desc-group" class="form-group" style="display: none;"> <label>图片描述 (必填，给AI看)</label> <input type="text" id="post-image-description" placeholder="简单描述图片内容，帮助AI理解"> </div>
        </div>
        <div id="text-image-mode-content" class="post-mode-content">
          <div class="form-group"> <label>文字图 (给AI理解用的描述，点击图片后可见)</label> <textarea id="post-hidden-text" rows="4" placeholder="在这里写下图片描述..."></textarea> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-post-btn">取消</button> <button class="save" id="confirm-create-post-btn">发布</button> </div>
    </div>
  </div> <input type="file" id="ai-avatar-upload-input" accept="image/*" hidden> <input type="file" id="group-avatar-upload-input" accept="image/*" hidden>
  <div id="qzone-sticker-panel">
    <div id="qzone-sticker-grid"></div>
  </div>
  <div id="avatar-frame-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>选择头像框</span>
        <div class="header-actions"> <button id="manage-frames-btn" class="action-button">管理</button> <button id="upload-custom-frame-btn" class="action-button">上传</button> <button id="batch-import-frames-btn" class="action-button">批量</button> </div>
      </div>
      <div class="modal-body">
        <div class="frame-tabs">
          <div id="ai-frame-tab" class="frame-tab active">对方的</div>
          <div id="my-frame-tab" class="frame-tab">我的</div>
        </div>
        <div id="ai-frame-content" class="frame-content">
          <div id="ai-frame-grid" class="frame-grid"> </div>
        </div>
        <div id="my-frame-content" class="frame-content" style="display: none;">
          <div id="my-frame-grid" class="frame-grid"> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-frame-settings-btn">取消</button> <button class="save" id="save-frame-settings-btn">保存</button> </div>
      <div id="frame-action-bar" style="display: none;"> <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-frames-checkbox"> 全选 </label> <button id="delete-selected-frames-btn" class="action-bar-btn">删除 (0)</button>
      </div>
    </div>
  </div><input type="file" id="custom-frame-upload-input" accept="image/*" hidden>
  <div id="character-profile-modal" class="modal">
    <div class="character-profile-content"> <button id="profile-history-icon-btn" title="查看历史心声"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg> </button>
      <div id="profile-main-content">
        <div id="profile-timestamp" class="thought-header"></div>
        <div class="thought-content">
          <div class="voice">
            <div class="label"> <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
              </svg> 心声 </div>
            <p id="profile-heartfelt-voice" class="text"></p>
          </div>
          <div class="jottings">
            <div class="label"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
              </svg> 散记 </div>
            <p id="profile-random-jottings" class="text"></p>
          </div>
        </div>
      </div>
      <div id="profile-thoughts-history-view">
        <div class="profile-header"> <span>心声记录</span> <button id="history-back-btn" title="返回"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg> </button> </div>
        <div id="thoughts-history-list"></div>
      </div>
    </div>
  </div> <input type="file" id="my-avatar-upload-input" accept="image/*" hidden>
  <div id="gift-recipient-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>选择收礼人</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-recipients"> 全选 </label> </div>
      <div class="modal-body" id="gift-recipient-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-gift-recipient-btn">取消</button> <button class="save" id="confirm-gift-recipient-btn">确认送出</button> </div>
    </div>
  </div> <audio id="notification-sound-player" preload="auto"></audio>
  <div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>搜索结果</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-music-search"> 全选 </label> </div>
      <div class="modal-body" id="search-results-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-music-search-btn">取消</button> <button class="save" id="add-selected-music-btn">添加选中</button> </div>
    </div>
  </div>
  <div id="douban-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>豆瓣设置</span> </div>
      <div class="modal-body">
        <div class="form-group douban-settings-item"> <label for="douban-min-posts-input"> 每次生成帖子数范围 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 设置AI在豆瓣页面一次性生成帖子的最小和最大数量。 </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="douban-min-posts-input" min="1" value="12"> <span>到</span> <input type="number" id="douban-max-posts-input" min="1" value="20"> <span>篇</span> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-douban-settings-btn">取消</button> <button class="save" id="save-douban-settings-btn">保存</button> </div>
    </div>
  </div><audio id="char-audio-player" preload="auto"></audio>
  <div id="douban-cast-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>选择参与豆瓣的角色</span> </div>
      <div class="modal-body" id="douban-cast-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-douban-cast-btn">取消</button> <button class="save" id="save-douban-cast-btn">保存并刷新</button> </div>
    </div>
  </div><input type="file" id="import-preset-input" accept=".json" hidden>
  <div id="update-notice-modal">
    <div class="update-notice-content">
      <div class="update-notice-body" id="update-notice-body"> </div>
      <div class="update-notice-footer"> <button id="update-notice-confirm-btn">我知道了</button> <button id="update-notice-dismiss-btn">不再提示</button> </div>
    </div>
  </div>
  <div id="delete-world-books-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>选择要删除的世界书</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-world-books-for-clear"> 全选 </label> </div>
      <div class="modal-body" id="delete-world-books-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-delete-world-books-btn">取消</button> <button class="save btn-danger" id="confirm-delete-world-books-btn">确认删除</button> </div>
    </div>
  </div>
  <div id="werewolf-kill-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>狼人请选择刀人对象</span></div>
      <div class="modal-body" id="werewolf-kill-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="cancel" id="cancel-wolf-kill-btn">放弃</button> <button class="save btn-danger" id="confirm-wolf-kill-btn">确认刀人</button> </div>
    </div>
  </div>
  <div id="werewolf-lobby-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span>选择玩家开始狼人杀</span> </div>
      <div class="modal-body" id="werewolf-player-selection-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-werewolf-lobby-btn">取消</button> <button class="save" id="start-werewolf-game-btn">开始游戏</button> </div>
    </div>
  </div>
  <div id="werewolf-role-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; text-align: center; padding: 20px;">
      <h3 id="werewolf-role-title" style="margin-top: 0;">你的身份是</h3>
      <div id="werewolf-role-card" style="margin: 15px 0;">
        <h2 id="werewolf-role-name" style="margin: 0 0 10px 0;"></h2>
        <p id="werewolf-role-description" style="font-size: 14px; line-height: 1.6; color: #555; margin: 0;"></p>
      </div> <button id="werewolf-role-confirm-btn" class="form-button">我准备好了</button>
    </div>
  </div>
  <div id="werewolf-prophet-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>预言家请选择查验对象</span></div>
      <div class="modal-body" id="werewolf-prophet-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-prophet-check-btn">确认查验</button> </div>
    </div>
  </div>
  <div id="werewolf-hunter-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>猎人请选择开枪对象</span></div>
      <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save btn-danger" id="confirm-hunter-shot-btn">确认开枪</button> </div>
    </div>
  </div>
  <div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>请投票放逐一名玩家</span></div>
      <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-vote-btn">确认投票</button> </div>
    </div>
  </div>
  <div id="werewolf-guard-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>守卫请选择今晚要守护的玩家</span></div>
      <div class="modal-body" id="werewolf-guard-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-guard-selection-btn">确认守护</button> </div>
    </div>
  </div>
  <div id="werewolf-witch-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span id="witch-modal-title">女巫请睁眼</span></div>
      <div class="modal-body" id="werewolf-witch-selection-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="witch-do-nothing-btn">什么都不做</button> <button class="save btn-danger" id="confirm-witch-poison-btn" style="display: none;">确认用毒</button> </div>
    </div>
  </div>
  <div id="werewolf-hunter-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>猎人请选择开枪对象</span></div>
      <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save btn-danger" id="confirm-hunter-shot-btn">确认开枪</button> </div>
    </div>
  </div>
  <div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>请投票放逐一名玩家</span></div>
      <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-vote-btn">确认投票</button> </div>
    </div>
  </div>
  <div id="werewolf-game-over-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto; text-align: center; padding: 20px;">
      <h2 id="werewolf-game-over-title">游戏结束</h2>
      <p id="werewolf-game-over-reason" style="font-size: 16px; margin: 20px 0;"></p>
      <div id="werewolf-role-reveal-list" style="max-height: 250px; overflow-y: auto; margin: 20px 0; border-top: 1px solid #444; padding-top: 10px;"> </div> <button id="werewolf-game-over-close-btn" class="form-button">返回大厅</button> <button id="manual-werewolf-summary-btn"
        class="form-button form-button-secondary" style="margin-top: 10px;">手动总结记忆</button>
    </div>
  </div>
  <div id="reading-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>我的书库</span>
        <div class="header-actions"> <span class="action-btn" id="import-new-book-btn-header" title="导入新书"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg> </span> <span class="action-btn" id="close-reading-library-btn-header" title="关闭"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg> </span> </div>
      </div>
      <div id="reading-library-search-container"> <input type="search" id="reading-library-search-input" placeholder="搜索书名..."> </div>
      <div class="modal-body" style="padding: 0; flex-grow: 1; overflow-y: auto;">
        <div id="reading-library-list"> </div>
      </div>
    </div>
  </div>
  <div id="product-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>管理商品分类</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>新建分类</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-product-category-name-input" placeholder="输入分类名..." style="flex-grow: 1;"> <button id="add-new-product-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">添加</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-product-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-product-category-manager-btn" style="width: 100%;">完成</button> </div>
    </div>
  </div>
  <div id="variation-selection-modal" class="modal">
    <div class="modal-content" style="width: 320px; height: auto;">
      <div class="modal-header" style="padding-bottom: 0;"> </div>
      <div class="modal-body">
        <div id="variation-product-info" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;"> <img id="variation-product-image" style="width: 80px; height: 80px; border-radius: 6px; object-fit: cover;">
          <div>
            <p id="variation-product-name" style="font-weight: 500; margin: 0;"></p>
            <p id="variation-selected-price" style="color: #ff5722; font-weight: bold; font-size: 18px; margin: 8px 0 0;"></p>
          </div>
        </div>
        <div class="form-group"> <label>选择款式</label>
          <div id="variation-options-container" style="display: flex; flex-wrap: wrap; gap: 8px;"> </div>
        </div>
        <div class="form-group"> <label>购买数量</label>
          <div class="quantity-control" style="justify-content: flex-start;"> <button class="quantity-btn" id="variation-decrease-qty">-</button> <span class="quantity-display" id="variation-quantity-display">1</span> <button class="quantity-btn" id="variation-increase-qty">+</button>
          </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-variation-selection-btn">取消</button> <button class="save" id="confirm-variation-selection-btn">加入购物车</button> </div>
    </div>
  </div>
  <div id="shopping-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>购物中心生成设置</span> </div>
      <div class="modal-body">
        <div class="form-group douban-settings-item"> <label for="shopping-category-count-input"> 生成分类数量 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 设置AI一次性生成多少个商品分类。 </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="shopping-category-count-input" min="1" max="10" value="3"> <span>个</span> </div>
        </div>
        <div class="form-group douban-settings-item"> <label for="shopping-product-count-input"> 每个分类商品数量 <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> 设置每个分类下生成多少个商品。 </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="shopping-product-count-input" min="2" max="10" value="8"> <span>个</span> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-shopping-settings-btn">取消</button> <button class="save" id="save-shopping-settings-btn">保存</button> </div>
    </div>
  </div>
  <div id="sticker-binding-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header">
        <span>绑定分类到聊天</span>
      </div>
      <div class="modal-body" id="sticker-binding-chat-list" style="padding: 0;">
        <!-- 聊天列表将在此处动态渲染 -->
      </div>
      <div class="modal-footer">
        <button class="cancel" id="cancel-sticker-binding-btn">取消</button>
        <button class="save" id="save-sticker-binding-btn">保存</button>
      </div>
    </div>
  </div>
<!-- ▼▼▼ NovelAI 生成设置弹窗 ▼▼▼ -->
<div id="novelai-settings-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
            <span>NovelAI 生成设置</span>
            <span class="close" id="close-novelai-settings" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label style="color: #333;">图像尺寸（oplus可无限出小图）</label>
                <select id="nai-resolution" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <optgroup label="小">
                        <option value="512x768">纵向 (512x768)</option>
                        <option value="768x512">横向 (768x512)</option>
                        <option value="640x640">正方形 (640x640)</option>
                    </optgroup>
                    <optgroup label="正常">
                        <option value="832x1216">竖图 (832x1216)</option>
                        <option value="1216x832">横图 (1216x832)</option>
                        <option value="1024x1024" selected>方图 (1024x1024)</option>
                    </optgroup>
                    <optgroup label="壁纸">
                        <option value="1088x1920">纵向 (1088x1920)</option>
                        <option value="1920x1088">风景 (1920x1088)</option>
                    </optgroup>
                </select>
                <small style="color: #666;">建议使用官方支持的标准尺寸以获得最佳效果</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">采样步数 (Steps)</label>
                <input type="number" id="nai-steps" value="28" min="1" max="50" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">推荐值: 28 (值越高质量越好但耗时越长)</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">提示词相关性 (CFG Scale)</label>
                <input type="number" id="nai-cfg-scale" value="5" min="1" max="20" step="0.5" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">推荐值: 5 (控制图像与提示词的相关程度)</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">采样器 (Sampler)</label>
                <select id="nai-sampler" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim">DDIM</option>
                </select>
            </div>

            <div class="form-group">
                <label style="color: #333;">随机种子 (Seed)</label>
                <input type="number" id="nai-seed" value="-1" min="-1" max="9999999999" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">-1 表示随机，固定种子可复现相同图像</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">负面提示词预设 (UC Preset)</label>
                <select id="nai-uc-preset" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="0">Preset 0 - Heavy</option>
                    <option value="1" selected>Preset 1 - Light</option>
                    <option value="2">Preset 2 - Human Focus</option>
                    <option value="3">Preset 3 - None</option>
                </select>
            </div>

            <div class="form-group">
                <label style="color: #333;">质量标签</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-quality-toggle" checked style="width: auto;">
                    <span style="color: #666; font-size: 14px;">自动添加质量提升标签</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">SMEA (提升细节)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea" checked style="width: auto;">
                    <span style="color: #666; font-size: 14px;">启用SMEA增强</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">SMEA DYN (动态优化)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea-dyn" style="width: auto;">
                    <span style="color: #666; font-size: 14px;">启用动态SMEA</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">默认正面提示词</label>
                <textarea id="nai-default-positive" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="masterpiece, best quality, 1girl, beautiful...">masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea>
                <small style="color: #666;">此提示词将在生成时自动使用（如果测试弹窗中未填写）</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">默认负面提示词</label>
                <textarea id="nai-default-negative" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="lowres, bad anatomy, bad hands, text, error...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
            </div>

            <div class="form-group" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                <label style="color: #333;">🌐 CORS 代理设置</label>
                <select id="nai-cors-proxy" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="">❌ 直连（无代理）</option>
                    <option value="https://corsproxy.io/?" selected>✅ corsproxy.io（推荐）</option>
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere（需激活）</option>
                    <option value="custom">🔧 自定义代理</option>
                </select>
                <small style="color: #e74c3c; display: block; margin-top: 8px;">
                    ⚠️ 本地运行会遇到CORS跨域问题，需使用代理。推荐使用 corsproxy.io
                </small>
            </div>

            <div id="nai-custom-proxy-group" class="form-group" style="display: none;">
                <label style="color: #333;">自定义代理地址</label>
                <input type="text" id="nai-custom-proxy-url" placeholder="https://your-proxy.com/?" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">代理URL应以 / 或 ? 结尾，例如：https://proxy.com/?</small>
            </div>
        </div>
        <div class="modal-footer">
            <button id="reset-nai-settings-btn" class="form-button form-button-secondary" style="margin-right: 10px;">恢复默认</button>
            <button id="save-nai-settings-btn" class="form-button form-button-secondary">保存设置</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ NovelAI 生成设置弹窗结束 ▲▲▲ -->

<!-- ▼▼▼ NovelAI 测试生成弹窗 ▼▼▼ -->
<div id="novelai-test-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <span>🖼️ NovelAI 测试生成</span>
            <span class="close" id="close-novelai-test" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label style="color: #333;">正面提示词（此处提示词仅用于该弹窗测试）</label>
                <textarea id="nai-test-prompt" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="1girl, solo, long hair, blue eyes, smile...">1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea>
            </div>

            <div class="form-group">
                <label style="color: #333;">负面提示词（可选，留空使用默认）</label>
                <textarea id="nai-test-negative" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="留空将使用设置中的默认负面提示词"></textarea>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button id="nai-generate-btn" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    生成图像
                </button>
            </div>

            <div id="nai-test-status" style="text-align: center; color: #666; margin: 15px 0; display: none;">
                正在生成中，请稍候...
            </div>

            <div id="nai-test-result" style="display: none; margin-top: 20px;">
                <div style="font-weight: bold; color: #333; margin-bottom: 10px;">生成结果：</div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <img id="nai-result-image" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button id="nai-download-btn" class="form-button-secondary" style="margin: 0;">下载图像</button>
                </div>
            </div>

            <div id="nai-test-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; color: #721c24; border-radius: 6px; border: 1px solid #f5c6cb;"></div>
        </div>
        <div class="modal-footer">
            <button id="close-nai-test-btn" class="form-button">关闭</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ NovelAI 测试生成弹窗结束 ▲▲▲ -->

<!-- ▼▼▼ 角色专属NAI出图设置弹窗 ▼▼▼ -->
<div id="character-nai-prompts-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span>角色专属NAI提示词配置</span>
            <span class="close" id="close-character-nai-prompts" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body">
            <p style="font-size: 13px; color: #666; margin-bottom: 20px; background-color: #f0f8ff; padding: 12px; border-radius: 6px; border-left: 3px solid #007bff;">
                💡 这里配置的提示词仅用于当前角色的NAI出图，不影响其他角色或系统设置
            </p>
            
            <div class="form-group">
                <label for="character-nai-positive" style="color: #333; font-weight: 600;">
                    正面提示词 (Positive Prompt)
                </label>
                <textarea id="character-nai-positive" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical; font-size: 13px;" placeholder="例如: masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style"></textarea>
                <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                    描述你希望生成的图像风格，可填入画师串
                </small>
            </div>

            <div class="form-group">
                <label for="character-nai-negative" style="color: #333; font-weight: 600;">
                    负面提示词 (Negative Prompt)
                </label>
                <textarea id="character-nai-negative" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical; font-size: 13px;" placeholder="例如: lowres, bad anatomy, bad hands, text, error, missing fingers"></textarea>
                <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                    描述你希望避免的元素
                </small>
            </div>
        </div>
        <div class="modal-footer">
            <button id="reset-character-nai-prompts-btn" class="form-button form-button-secondary" style="margin-right: 10px;">清空配置</button>
            <button id="save-character-nai-prompts-btn" class="form-button form-button-secondary">保存</button>
        </div>
    </div>
</div>
<!-- ▲▲▲ 角色专属NAI出图设置弹窗结束 ▲▲▲ -->

<audio id="silent-audio-player" loop preload="auto" style="display:none;">
    <source src="https://phoebeboo.github.io/mewoooo/1-second-of-silence.mp3" type="audio/mpeg">
  </audio><audio id="tts-audio-player" style="display:none;"></audio>

<script>
    // ========================================
    // 🖼️ NAI图片三击下载功能（非入侵式）
    // ========================================
    // 功能：为所有NAI图片（realimag-image、naiimag-image）添加三击下载功能
    // 适用场景：群聊、私聊、动态、测试弹窗等所有显示NAI图片的地方
    // 实现方式：事件委托，不修改任何现有代码
    // 触发方式：在图片上快速点击三次
    // ========================================
    
    (function() {
        'use strict';
        
        // 下载图片的核心函数
        function downloadImage(imageSrc, filename) {
            try {
                // 创建一个隐藏的下载链接
                const link = document.createElement('a');
                link.href = imageSrc;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();  // 触发下载
                
                // 短暂延迟后移除链接
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
                
                console.log('✅ [NAI下载] 开始下载图片:', filename);
                
                // 显示下载提示
                showDownloadToast();
            } catch (error) {
                console.error('❌ [NAI下载] 下载失败:', error);
                showDownloadToast('下载失败，请重试', 'error');
            }
        }
        
        // 显示下载提示（临时Toast）
        function showDownloadToast(message = '📥 图片下载中...', type = 'success') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                pointer-events: none;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // 动画进入
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // 2秒后淡出并移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // 生成智能文件名
        function generateFilename(imgElement) {
            // 尝试从title属性获取prompt（用于文件名）
            const title = imgElement.getAttribute('title') || imgElement.getAttribute('alt') || '';
            
            // 清理title，提取前30个有效字符
            let cleanTitle = title
                .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_')  // 保留中英文字母数字和空格
                .replace(/\s+/g, '_')  // 空格转下划线
                .substring(0, 30);
            
            if (!cleanTitle) {
                cleanTitle = 'NAI_Image';
            }
            
            // 添加时间戳（精确到秒）
            const timestamp = new Date().toISOString()
                .replace(/[-:]/g, '')
                .replace('T', '_')
                .split('.')[0];  // 格式：20250124_123045
            
            // 生成文件名
            return `${cleanTitle}_${timestamp}.png`;
        }
        
        // 为图片添加双击时的视觉反馈
        function addVisualFeedback(imgElement) {
            const originalTransform = imgElement.style.transform || '';
            const originalTransition = imgElement.style.transition || '';
            
            // 添加缩放动画
            imgElement.style.transition = 'transform 0.15s ease';
            imgElement.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                imgElement.style.transform = originalTransform;
                setTimeout(() => {
                    imgElement.style.transition = originalTransition;
                }, 150);
            }, 150);
        }
        
        // 三击检测相关变量
        let clickCount = 0;
        let clickTimer = null;
        let lastClickedElement = null;
        
        // 全局事件监听器（事件委托 - 三击触发）
        document.addEventListener('click', function(e) {
            const target = e.target;
            
            // 检查是否是NAI图片（realimag-image 或 naiimag-image）
            if (target.tagName === 'IMG' && 
                (target.classList.contains('realimag-image') || 
                 target.classList.contains('naiimag-image'))) {
                
                // 如果点击的是同一个元素，增加计数
                if (target === lastClickedElement) {
                    clickCount++;
                } else {
                    // 点击了不同的元素，重置计数
                    clickCount = 1;
                    lastClickedElement = target;
                }
                
                // 清除之前的定时器
                if (clickTimer) {
                    clearTimeout(clickTimer);
                }
                
                // 如果达到三击
                if (clickCount === 3) {
                    // 重置计数
                    clickCount = 0;
                    lastClickedElement = null;
                    
                    // 阻止默认行为和事件冒泡
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('🖼️ [NAI下载] 检测到三击NAI图片');
                    
                    // 添加视觉反馈
                    addVisualFeedback(target);
                    
                    // 获取图片源（可能是base64或URL）
                    const imageSrc = target.src;
                    
                    if (!imageSrc || imageSrc === 'about:blank') {
                        console.warn('⚠️ [NAI下载] 图片源为空，无法下载');
                        showDownloadToast('图片加载中，请稍后重试', 'error');
                        return;
                    }
                    
                    // 生成文件名
                    const filename = generateFilename(target);
                    
                    // 触发下载
                    downloadImage(imageSrc, filename);
                } else {
                    // 设置定时器，500ms后重置计数（如果用户停止点击）
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                        lastClickedElement = null;
                    }, 500);
                }
            }
        }, true);  // 使用捕获阶段，确保优先处理
        
        console.log('✅ [NAI下载] 三击下载功能已初始化');
        console.log('💡 [NAI下载] 提示：三击任意NAI图片即可下载');
    })();
    
    </script>

</body>
  <!-- ======= 锁屏&主页面切换脚本 ======= -->
  <script>
    // 动态更新时间和日期
    function updateLockTime() {
      const now = new Date();
      let h = now.getHours(), m = now.getMinutes();
      if(h<10) h="0"+h; if(m<10) m="0"+m;
      document.getElementById("lock-main-time").innerText = `${h}:${m}`;
      const weekday = "日一二三四五六".charAt(now.getDay());
      document.getElementById("lock-main-date").innerText = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 星期${weekday}`;
    }
    setInterval(updateLockTime, 1000); updateLockTime();

    // 解锁事件
    let lockScreen = document.getElementById("lock-screen");
    lockScreen.addEventListener("click", unlock);
    lockScreen.addEventListener("touchstart", handleTouchStart, false);
    let y0=null;
    function handleTouchStart(e){
      y0=e.touches[0].clientY;
      lockScreen.addEventListener("touchmove", handleTouchMove, false);
    }
    function handleTouchMove(e){
      let y1=e.touches[0].clientY;
      if(y0!==null && y0-y1>50){
        unlock();
        y0=null;
        lockScreen.removeEventListener("touchmove",handleTouchMove);
      }
    }
    function unlock(){
      lockScreen.style.display = "none";
      document.getElementById("phone-screen").style.display = "";
      document.body.style.overflow="";
    }
    // 初始只显示锁屏
    document.getElementById("phone-screen").style.display = "none";
    document.body.style.overflow = "hidden";
  </script>
</body>
</html>
